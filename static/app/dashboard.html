<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œå° - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item active">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item" data-role="root">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">å·¥ä½œå°</h1>
            </header>
            
            <main class="content">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSubjects">-</div>
                        <div class="stat-label">æˆ‘çš„å­¦ç§‘</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEntities">-</div>
                        <div class="stat-label">æ€»å®ä½“æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalRelations">-</div>
                        <div class="stat-label">æ€»å…³ç³»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reviewProgress">-</div>
                        <div class="stat-label">å®¡æ ¸è¿›åº¦</div>
                    </div>
                </div>
                
                <!-- å­¦ç§‘åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        æˆ‘è´Ÿè´£çš„å­¦ç§‘
                    </div>
                    <div class="card-body" id="subjectList">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!requireAuth()) {
            // requireAuth ä¼šè‡ªåŠ¨è·³è½¬
        }
        
        // åˆå§‹åŒ–é¡µé¢
        initPage();
        
        // åŠ è½½æ•°æ®
        loadDashboard();
        
        async function loadDashboard() {
            try {
                // è·å–å­¦ç§‘åˆ—è¡¨
                const subjectsResult = await api.review.getSubjects();
                const subjects = subjectsResult.subjects || [];
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalSubjects').textContent = subjects.length;
                
                // åŠ è½½å„å­¦ç§‘è¿›åº¦
                let totalEntities = 0;
                let totalRelations = 0;
                let totalReviewed = 0;
                let totalItems = 0;
                
                const subjectsWithProgress = await Promise.all(
                    subjects.map(async (subject) => {
                        try {
                            const progress = await api.review.getProgress(subject.subject_id);
                            totalEntities += progress.total_entities;
                            totalRelations += progress.total_relations;
                            totalReviewed += progress.reviewed_count;
                            totalItems += progress.total_entities + progress.total_relations;
                            return { ...subject, progress };
                        } catch (e) {
                            return { ...subject, progress: null };
                        }
                    })
                );
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalEntities').textContent = totalEntities.toLocaleString();
                document.getElementById('totalRelations').textContent = totalRelations.toLocaleString();
                
                const overallProgress = totalItems > 0 
                    ? Math.round(totalReviewed / totalItems * 100) 
                    : 0;
                document.getElementById('reviewProgress').textContent = `${overallProgress}%`;
                
                // æ¸²æŸ“å­¦ç§‘åˆ—è¡¨
                renderSubjects(subjectsWithProgress);
                
            } catch (error) {
                console.error('Load dashboard error:', error);
                document.getElementById('subjectList').innerHTML = 
                    '<p style="color: red;">åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        function renderSubjects(subjects) {
            const container = document.getElementById('subjectList');
            
            if (subjects.length === 0) {
                container.innerHTML = '<p>æš‚æ— åˆ†é…çš„å­¦ç§‘</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="subject-grid">
                    ${subjects.map(s => `
                        <div class="subject-card" onclick="goToReview('${s.subject_id}')">
                            <div class="subject-icon">${s.icon || 'ğŸ“š'}</div>
                            <div class="subject-name">${s.display_name}</div>
                            ${s.progress ? `
                                <div class="progress" style="margin: 10px 0;">
                                    <div class="progress-bar" style="width: ${s.progress.progress_percent}%">
                                        ${s.progress.progress_percent}%
                                    </div>
                                </div>
                                <div class="subject-stats">
                                    <span>å®ä½“: ${s.progress.total_entities}</span>
                                    <span>å…³ç³»: ${s.progress.total_relations}</span>
                                    <span>å·²å®¡: ${s.progress.reviewed_count}</span>
                                </div>
                            ` : '<div class="subject-stats">åŠ è½½ä¸­...</div>'}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function goToReview(subjectId) {
            window.location.href = `/static/app/review.html?subject=${subjectId}`;
        }
    </script>
</body>
</html>
