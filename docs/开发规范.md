# 开发规范

本文档定义了知识图谱可视化系统的代码规范和数据规范，供团队成员和AI模型协作参考。

## 一、目录结构规范

```
get_neooo_html/
├── manage.py              # 唯一入口，所有功能通过子命令调用
├── src/                   # 核心业务逻辑
│   ├── config.py         # 统一配置（学科、颜色、路径）
│   ├── graph_generator.py # HTML图谱生成
│   ├── neo4j_importer.py  # 数据库导入
│   ├── neo4j_query_api.py # 查询API服务
│   ├── update_index.py    # 导航页面更新
│   └── start_server.py    # HTTP服务器
├── scripts/               # 工具脚本（非核心功能）
│   ├── data_normalizer.py # 数据规范化
│   ├── json2csv.py        # 数据导出
│   ├── data_analyzer.py   # 数据分析
│   ├── cypher/            # Cypher查询脚本
│   └── deprecated/        # 废弃脚本（保留参考）
├── docs/                  # 所有文档
├── logs/                  # 日志输出
├── static/                # 生成的HTML（只读，勿手动修改）
├── templates/             # HTML模板
└── 图谱数据/              # 数据目录
    ├── 高中数学-v1/
    │   ├── entities/      # 实体文件
    │   └── relations/     # 关系文件
    └── ...
```

## 二、命名规范

### 2.1 目录和文件命名

| 类型 | 规范 | 正确示例 | 错误示例 |
|-----|------|---------|---------|
| 学科目录 | `{学段}{学科}-v{版本}` | `高中数学-v1` | `高中数学_with-books` |
| 实体文件 | PascalCase.json | `CoreLiteracy.json` | `coreliteracy.json` |
| 关系文件 | `{源类型}_{目标类型}.json` | `Chapter_Section.json` | `Chapter-Section.json` |
| Python模块 | snake_case.py | `graph_generator.py` | `GraphGenerator.py` |
| 文档 | 中文或snake_case.md | `开发规范.md` | `开发-规范.md` |

### 2.2 代码命名

| 类型 | 规范 | 示例 |
|-----|------|-----|
| 类名 | PascalCase | `GraphGenerator` |
| 函数名 | snake_case | `generate_html()` |
| 变量名 | snake_case | `entity_count` |
| 常量 | UPPER_SNAKE_CASE | `SUBJECT_CONFIG` |
| 配置key | snake_case | `data_dir`, `neo4j_label` |

## 三、数据格式规范

### 3.1 实体JSON结构

```json
{
  "identifier": "urn:jy:{subject}:{code}:{Type}:{id}",
  "type": "PascalCase类型名（与文件名一致）",
  "title": "实体名称（必填）",
  "description": "描述文本（可选）",
  "subject": "学科代码（可选）",
  "applicableLevel": "适用等级（可选）",
  "contentJson": {
    "扩展字段": "值"
  }
}
```

**必填字段**：
- `identifier` - URN格式唯一标识
- `type` - 实体类型，必须与JSON文件名一致
- `title` - 实体名称

**identifier格式**：
```
urn:jy:{学科代码}:{标准代码}:{等级代码}:{类型}:{序号}
示例: urn:jy:math:SB0201:OB06:Chapter:1
```

### 3.2 关系JSON结构

```json
{
  "relationName": "camelCase关系类型名",
  "label": "中文标签 / englishLabel",
  "source": "源实体identifier",
  "target": "目标实体identifier"
}
```

**必填字段**：
- `relationName` - 关系类型（camelCase）
- `source` - 源实体identifier
- `target` - 目标实体identifier

### 3.3 文件组织

```
图谱数据/{学科目录}/
├── entities/              # 实体目录
│   ├── Chapter.json      # 章
│   ├── Section.json      # 节
│   ├── CoreLiteracy.json # 核心素养
│   └── ...
├── relations/            # 关系目录
│   ├── Chapter_Section.json
│   ├── Section_KeyPoint.json
│   └── ...
└── version.json          # 版本信息（可选）
```

## 四、代码规范

### 4.1 入口规范

- **唯一入口**：所有功能通过 `manage.py` 子命令暴露
- **新增功能**：在 `manage.py` 中添加子命令，实现放在 `src/` 目录

```python
# 正确：通过manage.py暴露
python3 manage.py generate --subject 高中数学

# 避免：直接运行src下的模块
python3 src/graph_generator.py  # 不推荐
```

### 4.2 配置规范

- **统一配置**：所有配置集中在 `src/config.py`
- **学科配置**：新增学科在 `SUBJECT_CONFIG` 中添加
- **实体类型**：新增实体类型在 `ENTITY_TYPE_CONFIG` 中添加

```python
# src/config.py 配置示例
SUBJECT_CONFIG = {
    "高中数学": {
        "icon": "📐",
        "display_name": "高中数学",
        "data_dir": "高中数学-v1",      # 数据目录名
        "files": ["高中数学_课标.html"], # 输出文件名
        "color": "#2ecc71",
        "neo4j_label": "GaoZhongShuXue"  # Neo4j标签
    }
}
```

### 4.3 日志规范

- 日志文件输出到 `logs/` 目录
- 使用 `print()` 输出用户可见信息
- 使用日志文件记录详细操作

### 4.4 废弃代码处理

- 废弃代码移到 `scripts/deprecated/`
- 在 `scripts/deprecated/README.md` 中说明废弃原因和替代方案

## 五、Git规范

### 5.1 忽略文件

以下文件/目录不应提交：
- `__pycache__/`
- `.env`（包含密码）
- `logs/`
- `图谱数据.backup.*`
- `.bak/`
- `*.zip`

### 5.2 提交信息

```
类型: 简短描述

详细说明（可选）

类型包括：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- refactor: 重构
- style: 格式调整
- chore: 杂项
```

## 六、与AI模型协作指南

### 6.1 任务描述模板

```
任务：{具体任务描述}
涉及文件：{相关文件路径}
注意事项：
1. 所有新功能通过 manage.py 暴露
2. 配置修改在 src/config.py
3. 数据文件命名使用 PascalCase
4. 遵循现有代码风格
```

### 6.2 常见操作说明

| 操作 | 方式 |
|-----|------|
| 添加新学科 | 修改 `src/config.py` 的 `SUBJECT_CONFIG` |
| 添加新实体类型 | 修改 `src/config.py` 的 `ENTITY_TYPE_CONFIG` |
| 添加新命令 | 在 `manage.py` 中添加子命令 |
| 添加工具脚本 | 放在 `scripts/` 目录 |
| 修改HTML模板 | 编辑 `templates/graph_template.html` |

### 6.3 禁止操作

- 不要直接修改 `static/` 下的HTML文件
- 不要在顶层目录创建新的Python文件
- 不要硬编码数据目录路径
- 不要提交 `.env` 文件

## 七、数据版本管理

### 7.1 版本命名

格式：`{学段}{学科}-v{主版本}.{修订版本}`

- `v1` - 初始版本
- `v1.1` - 审核修正版本
- `v2` - 重大结构调整

### 7.2 版本元数据

每个学科目录可包含 `version.json`：

```json
{
  "version": "v1.1",
  "baseVersion": "v1",
  "createTime": "2026-01-22",
  "changes": [
    {"type": "entity_fix", "count": 15},
    {"type": "relation_fix", "count": 8}
  ],
  "status": "reviewed"
}
```
