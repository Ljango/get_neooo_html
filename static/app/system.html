<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <style>
        .output-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: var(--radius);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .output-panel.loading::after {
            content: 'æ‰§è¡Œä¸­...';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .operation-section {
            margin-bottom: 30px;
        }
        
        .operation-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .subject-select-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .subject-select-row select {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item active" data-role="root">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">ç³»ç»Ÿç®¡ç†ï¼ˆä»…rootå¯ç”¨ï¼‰</h1>
            </header>
            
            <main class="content">
                <!-- å­¦ç§‘é€‰æ‹© -->
                <div class="subject-select-row">
                    <label>é€‰æ‹©å­¦ç§‘ï¼š</label>
                    <select id="subjectSelect">
                        <option value="">å…¨éƒ¨å­¦ç§‘</option>
                    </select>
                    <span style="color: var(--text-muted); font-size: 13px;">ï¼ˆç•™ç©ºè¡¨ç¤ºæ“ä½œæ‰€æœ‰å­¦ç§‘ï¼‰</span>
                </div>
                
                <!-- æ•°æ®æ£€æŸ¥ä¸ä¿®å¤ -->
                <div class="operation-section">
                    <h3>ğŸ“‹ æ•°æ®æ£€æŸ¥ä¸ä¿®å¤</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('normalize-check')">
                            <i>ğŸ”</i>
                            <div class="title">æ£€æŸ¥æ•°æ®è§„èŒƒ</div>
                            <div class="desc">æ£€æŸ¥æ•°æ®æ ¼å¼é—®é¢˜</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('normalize-fix')">
                            <i>ğŸ”§</i>
                            <div class="title">ä¿®å¤æ•°æ®è§„èŒƒ</div>
                            <div class="desc">è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('analyze')">
                            <i>ğŸ“Š</i>
                            <div class="title">è´¨é‡åˆ†æ</div>
                            <div class="desc">ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š</div>
                        </div>
                    </div>
                </div>
                
                <!-- å›¾è°±ç”Ÿæˆ -->
                <div class="operation-section">
                    <h3>ğŸŒ å›¾è°±ç”Ÿæˆ</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('generate-html')">
                            <i>ğŸ“„</i>
                            <div class="title">ç”ŸæˆHTML</div>
                            <div class="desc">é‡æ–°ç”Ÿæˆå›¾è°±é¡µé¢</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('sync')">
                            <i>ğŸ”„</i>
                            <div class="title">åŒæ­¥æ•°æ®</div>
                            <div class="desc">ç”ŸæˆHTML+æ›´æ–°ç´¢å¼•</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®åº“æ“ä½œ -->
                <div class="operation-section">
                    <h3>ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('import-neo4j')">
                            <i>ğŸ“¥</i>
                            <div class="title">å¯¼å…¥Neo4j</div>
                            <div class="desc">åŒæ­¥åˆ°å›¾æ•°æ®åº“</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('export')">
                            <i>ğŸ“¤</i>
                            <div class="title">å¯¼å‡ºExcel</div>
                            <div class="desc">å¯¼å‡ºæ•°æ®åˆ°Excel</div>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å‡ºé¢æ¿ -->
                <div class="card">
                    <div class="card-header">
                        æ‰§è¡Œè¾“å‡º
                        <button class="btn" onclick="clearOutput()" style="padding: 4px 10px; font-size: 12px;">æ¸…ç©º</button>
                    </div>
                    <div class="card-body">
                        <div class="output-panel" id="outputPanel">ç­‰å¾…æ‰§è¡Œå‘½ä»¤...</div>
                    </div>
                </div>
                
                <!-- æ“ä½œæ—¥å¿— -->
                <div class="card">
                    <div class="card-header">
                        æœ€è¿‘æ“ä½œæ—¥å¿—
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>ç”¨æˆ·</th>
                                        <th>æ“ä½œ</th>
                                        <th>è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <tr><td colspan="4" class="loading">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="toast-container"></div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥rootæƒé™
        if (!requireRole('root')) {
            // è‡ªåŠ¨è·³è½¬
        }
        
        initPage();
        
        // åŠ è½½æ•°æ®
        loadSubjects();
        loadLogs();
        
        async function loadSubjects() {
            try {
                const result = await api.data.getSubjects();
                const select = document.getElementById('subjectSelect');
                
                result.subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Load subjects error:', error);
            }
        }
        
        async function loadLogs() {
            const tbody = document.getElementById('logTableBody');
            
            try {
                const result = await api.admin.getLogs({ page_size: 20 });
                
                if (result.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">æš‚æ— æ—¥å¿—</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.logs.map(log => `
                    <tr>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                        <td>${log.user_name || '-'}</td>
                        <td>${getActionText(log.action)}</td>
                        <td>${log.details ? JSON.stringify(log.details).substring(0, 50) : '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color:red;">åŠ è½½å¤±è´¥</td></tr>`;
            }
        }
        
        async function runOperation(type) {
            const subject = document.getElementById('subjectSelect').value || null;
            const panel = document.getElementById('outputPanel');
            
            panel.textContent = 'æ‰§è¡Œä¸­...\n';
            panel.classList.add('loading');
            
            try {
                let result;
                
                switch (type) {
                    case 'normalize-check':
                        result = await api.data.normalize(subject, false);
                        break;
                    case 'normalize-fix':
                        if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ•°æ®ä¿®å¤å—ï¼Ÿè¿™å°†ä¿®æ”¹æ•°æ®æ–‡ä»¶ã€‚')) return;
                        result = await api.data.normalize(subject, true);
                        break;
                    case 'analyze':
                        result = await api.data.analyze(subject);
                        break;
                    case 'generate-html':
                        result = await api.data.generateHtml(subject);
                        break;
                    case 'sync':
                        result = await api.data.sync(subject);
                        break;
                    case 'import-neo4j':
                        result = await api.data.importNeo4j(subject, 'local', false);
                        break;
                    case 'export':
                        result = await api.data.exportData(subject);
                        break;
                }
                
                panel.textContent = result.output || result.message || 'æ‰§è¡Œå®Œæˆ';
                
                if (result.success) {
                    showToast('æ‰§è¡ŒæˆåŠŸ', 'success');
                } else {
                    showToast('æ‰§è¡Œå¤±è´¥', 'error');
                }
                
                // åˆ·æ–°æ—¥å¿—
                loadLogs();
                
            } catch (error) {
                panel.textContent = 'é”™è¯¯: ' + error.message;
                showToast('æ‰§è¡Œå¤±è´¥: ' + error.message, 'error');
            } finally {
                panel.classList.remove('loading');
            }
        }
        
        function clearOutput() {
            document.getElementById('outputPanel').textContent = 'ç­‰å¾…æ‰§è¡Œå‘½ä»¤...';
        }
        
        function getActionText(action) {
            const map = {
                'login': 'ç™»å½•',
                'logout': 'é€€å‡º',
                'create_user': 'åˆ›å»ºç”¨æˆ·',
                'update_user': 'æ›´æ–°ç”¨æˆ·',
                'delete_user': 'åˆ é™¤ç”¨æˆ·',
                'reset_password': 'é‡ç½®å¯†ç ',
                'assign_subject': 'åˆ†é…å­¦ç§‘',
                'remove_assignment': 'ç§»é™¤åˆ†é…',
                'submit_review': 'æäº¤å®¡æ ¸',
                'data_normalize': 'æ•°æ®è§„èŒƒåŒ–',
                'data_analyze': 'æ•°æ®åˆ†æ',
                'generate_html': 'ç”ŸæˆHTML',
                'import_neo4j': 'å¯¼å…¥Neo4j',
                'sync_data': 'åŒæ­¥æ•°æ®',
                'export_data': 'å¯¼å‡ºæ•°æ®',
                'change_password': 'ä¿®æ”¹å¯†ç '
            };
            return map[action] || action;
        }
    </script>
</body>
</html>
