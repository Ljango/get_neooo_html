<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å®¡æ ¸ - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <style>
        .review-layout {
            display: flex;
            gap: 20px;
            height: calc(100vh - 100px);
        }
        
        .list-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }
        
        .entity-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-light);
        }
        
        .entity-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .entity-item:hover {
            background: #f5f7fa;
        }
        
        .entity-item.active {
            background: #e6f4ff;
            border-left: 3px solid var(--primary-color);
        }
        
        .entity-item .title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .entity-item .meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius);
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .property-list {
            display: grid;
            gap: 10px;
        }
        
        .property-item {
            display: flex;
        }
        
        .property-item .label {
            width: 100px;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        
        .property-item .value {
            flex: 1;
        }
        
        .relation-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .relation-item {
            padding: 10px;
            background: var(--bg-color);
            border-radius: 4px;
            font-size: 13px;
        }
        
        .review-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-light);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius) var(--radius);
        }
        
        .review-actions textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            resize: none;
            height: 60px;
        }
        
        .review-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: var(--bg-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* ç¼–è¾‘åŠŸèƒ½æ ·å¼ */
        .edit-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f7ff;
            border-radius: var(--radius);
            border: 1px solid #d0e3ff;
        }
        
        .edit-toolbar .btn {
            font-size: 13px;
            padding: 6px 12px;
        }
        
        .btn-edit {
            background: #1890ff;
            color: white;
            border: none;
        }
        
        .btn-edit:hover {
            background: #40a9ff;
        }
        
        .btn-graph {
            background: #52c41a;
            color: white;
            border: none;
        }
        
        .btn-graph:hover {
            background: #73d13d;
        }
        
        .btn-add-relation {
            background: #722ed1;
            color: white;
            border: none;
        }
        
        .btn-add-relation:hover {
            background: #9254de;
        }
        
        .relation-item {
            position: relative;
            padding-right: 40px;
        }
        
        .relation-item .delete-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .relation-item .delete-btn:hover {
            opacity: 1;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* å›¾è°±å¯è§†åŒ–å®¹å™¨ */
        .graph-container {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: #fafafa;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item active">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item" data-role="root">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">æ•°æ®å®¡æ ¸</h1>
                <div class="header-actions">
                    <select id="subjectSelect" class="form-control">
                        <option value="">é€‰æ‹©å­¦ç§‘...</option>
                    </select>
                </div>
            </header>
            
            <main class="content">
                <div class="review-layout">
                    <!-- åˆ—è¡¨é¢æ¿ -->
                    <div class="list-panel">
                        <div class="tab-bar">
                            <button class="tab-btn active" data-type="entity" onclick="switchTab('entity')">å®ä½“</button>
                            <button class="tab-btn" data-type="relation" onclick="switchTab('relation')">å…³ç³»</button>
                        </div>
                        
                        <div class="filter-bar">
                            <select id="statusFilter" onchange="loadList()">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="pending">å¾…å®¡æ ¸</option>
                                <option value="approved">å·²é€šè¿‡</option>
                                <option value="needs_fix">éœ€ä¿®æ”¹</option>
                            </select>
                            <select id="typeFilter" onchange="loadList()">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                            </select>
                        </div>
                        
                        <div class="entity-list" id="itemList">
                            <div class="empty-state">è¯·å…ˆé€‰æ‹©å­¦ç§‘</div>
                        </div>
                        
                        <div class="pagination" id="pagination"></div>
                    </div>
                    
                    <!-- è¯¦æƒ…é¢æ¿ -->
                    <div class="detail-panel">
                        <div class="detail-content" id="detailContent">
                            <div class="empty-state">é€‰æ‹©å·¦ä¾§é¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</div>
                        </div>
                        
                        <div class="review-actions" id="reviewActions" style="display: none;">
                            <textarea id="reviewComment" placeholder="å®¡æ ¸æ„è§ï¼ˆå¯é€‰ï¼‰"></textarea>
                            <div class="review-buttons">
                                <button class="btn btn-success" onclick="submitReview('approved')">é€šè¿‡</button>
                                <button class="btn btn-warning" onclick="submitReview('needs_fix')">éœ€ä¿®æ”¹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="toast-container"></div>
    
    <!-- å®ä½“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editEntityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘å®ä½“å±æ€§</h3>
                <button class="modal-close" onclick="closeModal('editEntityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editEntityForm">
                    <div class="form-group">
                        <label>æ ‡è¯†ç¬¦ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                        <input type="text" id="editEntityId" disabled>
                    </div>
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="editEntityTitle" required>
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="editEntityDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <input type="text" id="editEntityType">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editEntityModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEntityEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ å…³ç³»æ¨¡æ€æ¡† -->
    <div class="modal" id="addRelationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ å…³ç³»</h3>
                <button class="modal-close" onclick="closeModal('addRelationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addRelationForm">
                    <div class="form-group">
                        <label>æºå®ä½“</label>
                        <input type="text" id="relationSource" required>
                    </div>
                    <div class="form-group">
                        <label>å…³ç³»ç±»å‹</label>
                        <select id="relationName" required>
                            <option value="åŒ…å«">åŒ…å«</option>
                            <option value="å±äº">å±äº</option>
                            <option value="ç›¸å…³">ç›¸å…³</option>
                            <option value="å‰ç½®">å‰ç½®</option>
                            <option value="åç»­">åç»­</option>
                            <option value="ä¾èµ–">ä¾èµ–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡å®ä½“</label>
                        <input type="text" id="relationTarget" required>
                    </div>
                    <div class="form-group">
                        <label>æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="relationLabel">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addRelationModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNewRelation()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- å›¾è°±å¯è§†åŒ–æ¨¡æ€æ¡† -->
    <div class="modal" id="graphModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>å›¾è°±å¯è§†åŒ–</h3>
                <button class="modal-close" onclick="closeModal('graphModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="graph-container" id="graphContainer">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('graphModal')">å…³é—­</button>
                <a id="graphFullLink" href="#" target="_blank" class="btn btn-primary">å…¨å±æŸ¥çœ‹</a>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="closeModal('confirmDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³ç³»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('confirmDeleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        if (!requireAuth()) {
            // è‡ªåŠ¨è·³è½¬
        }
        
        initPage();
        
        // çŠ¶æ€
        let currentSubject = null;
        let currentTab = 'entity';
        let currentItem = null;
        let currentPage = 1;
        const pageSize = 50;
        
        // ä»URLè·å–å­¦ç§‘å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const urlSubject = urlParams.get('subject');
        
        // åŠ è½½å­¦ç§‘åˆ—è¡¨
        loadSubjects();
        
        async function loadSubjects() {
            try {
                const result = await api.review.getSubjects();
                const select = document.getElementById('subjectSelect');
                
                result.subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
                
                // å¦‚æœURLæœ‰å­¦ç§‘å‚æ•°ï¼Œè‡ªåŠ¨é€‰æ‹©
                if (urlSubject) {
                    select.value = urlSubject;
                    onSubjectChange();
                }
                
                select.addEventListener('change', onSubjectChange);
            } catch (error) {
                showToast('åŠ è½½å­¦ç§‘åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        function onSubjectChange() {
            currentSubject = document.getElementById('subjectSelect').value;
            currentPage = 1;
            currentItem = null;
            
            if (currentSubject) {
                loadTypeFilter();
                loadList();
            } else {
                document.getElementById('itemList').innerHTML = '<div class="empty-state">è¯·å…ˆé€‰æ‹©å­¦ç§‘</div>';
            }
            
            clearDetail();
        }
        
        async function loadTypeFilter() {
            // åŠ è½½å®ä½“ç±»å‹ç”¨äºç­›é€‰ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œä»å®ä½“æ•°æ®æ¨æ–­ï¼‰
            const typeSelect = document.getElementById('typeFilter');
            typeSelect.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>';
            
            if (currentTab === 'entity') {
                try {
                    const result = await api.review.getEntities(currentSubject, { page_size: 200 });
                    const types = [...new Set(result.entities.map(e => e.type))];
                    types.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t;
                        option.textContent = t;
                        typeSelect.appendChild(option);
                    });
                } catch (e) {}
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;
            currentItem = null;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === tab);
            });
            
            loadTypeFilter();
            loadList();
            clearDetail();
        }
        
        async function loadList() {
            if (!currentSubject) return;
            
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const listContainer = document.getElementById('itemList');
            
            listContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                let result;
                const params = {
                    page: currentPage,
                    page_size: pageSize,
                    status_filter: statusFilter || undefined,
                    entity_type: typeFilter || undefined
                };
                
                // æ¸…ç†undefinedå‚æ•°
                Object.keys(params).forEach(k => params[k] === undefined && delete params[k]);
                
                if (currentTab === 'entity') {
                    result = await api.review.getEntities(currentSubject, params);
                    renderEntityList(result.entities, result.total);
                } else {
                    result = await api.review.getRelations(currentSubject, params);
                    renderRelationList(result.relations, result.total);
                }
                
                renderPagination(result.total);
            } catch (error) {
                listContainer.innerHTML = `<div class="empty-state" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function renderEntityList(entities, total) {
            const container = document.getElementById('itemList');
            
            if (entities.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = entities.map(e => `
                <div class="entity-item" onclick="selectEntity('${encodeURIComponent(e.identifier)}')" data-id="${e.identifier}">
                    <div class="title">${e.title || e.identifier}</div>
                    <div class="meta">
                        <span>${e.type}</span>
                        ${e.review_status ? `<span class="badge badge-${e.review_status}">${getStatusText(e.review_status)}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function renderRelationList(relations, total) {
            const container = document.getElementById('itemList');
            
            if (relations.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = relations.map((r, idx) => `
                <div class="entity-item" onclick="selectRelation(${idx})" data-index="${idx}">
                    <div class="title">${r.source_title} â†’ ${r.target_title}</div>
                    <div class="meta">
                        <span>${r.relation_name}</span>
                        ${r.review_status ? `<span class="badge badge-${r.review_status}">${getStatusText(r.review_status)}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            // ä¿å­˜å…³ç³»æ•°æ®
            window._relations = relations;
        }
        
        function renderPagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            html += `<span style="padding: 8px;">${currentPage} / ${totalPages}</span>`;
            html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            container.innerHTML = html;
        }
        
        function goPage(page) {
            currentPage = page;
            loadList();
        }
        
        async function selectEntity(identifier) {
            // é«˜äº®é€‰ä¸­é¡¹
            document.querySelectorAll('.entity-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === decodeURIComponent(identifier));
            });
            
            try {
                const result = await api.review.getEntityDetail(currentSubject, decodeURIComponent(identifier));
                currentItem = {
                    type: 'entity',
                    id: result.entity.identifier,
                    title: result.entity.title,
                    entityType: result.entity.type
                };
                renderEntityDetail(result);
                document.getElementById('reviewActions').style.display = 'flex';
            } catch (error) {
                showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
            }
        }
        
        function selectRelation(index) {
            const relation = window._relations[index];
            
            // é«˜äº®é€‰ä¸­é¡¹
            document.querySelectorAll('.entity-item').forEach(el => {
                el.classList.toggle('active', el.dataset.index === String(index));
            });
            
            currentItem = {
                type: 'relation',
                id: `${relation.source}|${relation.target}|${relation.relation_name}`,
                title: `${relation.source_title} â†’ ${relation.target_title}`
            };
            
            renderRelationDetail(relation);
            document.getElementById('reviewActions').style.display = 'flex';
        }
        
        // ä¿å­˜å½“å‰å®ä½“æ•°æ®ç”¨äºç¼–è¾‘
        let currentEntityData = null;
        
        function renderEntityDetail(data) {
            const content = document.getElementById('detailContent');
            const entity = data.entity;
            
            // ä¿å­˜å½“å‰å®ä½“æ•°æ®
            currentEntityData = data;
            
            content.innerHTML = `
                <!-- ç¼–è¾‘å·¥å…·æ  -->
                <div class="edit-toolbar">
                    <button class="btn btn-edit" onclick="openEditEntityModal()">
                        âœï¸ ç¼–è¾‘å±æ€§
                    </button>
                    <button class="btn btn-add-relation" onclick="openAddRelationModal()">
                        â• æ·»åŠ å…³ç³»
                    </button>
                    <button class="btn btn-graph" onclick="openGraphModal()">
                        ğŸ”— æŸ¥çœ‹å›¾è°±
                    </button>
                </div>
                
                <div class="detail-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">æ ‡è¯†ç¬¦</span>
                            <span class="value">${entity.identifier}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">ç±»å‹</span>
                            <span class="value">${entity.type}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æ ‡é¢˜</span>
                            <span class="value">${entity.title || '-'}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æè¿°</span>
                            <span class="value">${entity.description || '-'}</span>
                        </div>
                        ${entity.subject ? `
                        <div class="property-item">
                            <span class="label">å­¦ç§‘</span>
                            <span class="value">${entity.subject}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${data.relations && data.relations.length > 0 ? `
                <div class="detail-section">
                    <h3>å…³è”å…³ç³» (${data.relations.length})</h3>
                    <div class="relation-list">
                        ${data.relations.map((r, idx) => `
                            <div class="relation-item">
                                ${r.direction === 'outgoing' ? 'â†’' : 'â†'} 
                                <strong>${r.relation_name}</strong>: 
                                ${r.direction === 'outgoing' ? r.target_title : r.source_title}
                                <button class="delete-btn" onclick="deleteRelation(${idx})">åˆ é™¤</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="detail-section">
                    <h3>å…³è”å…³ç³»</h3>
                    <div class="empty-state" style="padding: 20px;">æš‚æ— å…³è”å…³ç³»</div>
                </div>
                `}
                
                ${data.review ? `
                <div class="detail-section">
                    <h3>å®¡æ ¸è®°å½•</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">çŠ¶æ€</span>
                            <span class="value"><span class="badge badge-${data.review.status}">${getStatusText(data.review.status)}</span></span>
                        </div>
                        <div class="property-item">
                            <span class="label">å®¡æ ¸äºº</span>
                            <span class="value">${data.review.reviewer || '-'}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æ„è§</span>
                            <span class="value">${data.review.comment || '-'}</span>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        function renderRelationDetail(relation) {
            const content = document.getElementById('detailContent');
            
            content.innerHTML = `
                <div class="detail-section">
                    <h3>å…³ç³»ä¿¡æ¯</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">æºå®ä½“</span>
                            <span class="value">${relation.source_title} (${relation.source})</span>
                        </div>
                        <div class="property-item">
                            <span class="label">å…³ç³»ç±»å‹</span>
                            <span class="value">${relation.relation_name}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">ç›®æ ‡å®ä½“</span>
                            <span class="value">${relation.target_title} (${relation.target})</span>
                        </div>
                        ${relation.label ? `
                        <div class="property-item">
                            <span class="label">æ ‡ç­¾</span>
                            <span class="value">${relation.label}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function clearDetail() {
            document.getElementById('detailContent').innerHTML = '<div class="empty-state">é€‰æ‹©å·¦ä¾§é¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</div>';
            document.getElementById('reviewActions').style.display = 'none';
            document.getElementById('reviewComment').value = '';
        }
        
        async function submitReview(status) {
            if (!currentItem) return;
            
            const comment = document.getElementById('reviewComment').value;
            
            try {
                await api.review.submit({
                    subject_id: currentSubject,
                    target_type: currentItem.type,
                    target_id: currentItem.id,
                    target_title: currentItem.title,
                    entity_type: currentItem.entityType,
                    status: status,
                    comment: comment || null
                });
                
                showToast('å®¡æ ¸æäº¤æˆåŠŸ', 'success');
                document.getElementById('reviewComment').value = '';
                
                // åˆ·æ–°åˆ—è¡¨
                loadList();
            } catch (error) {
                showToast('æäº¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function getStatusText(status) {
            const map = {
                'pending': 'å¾…å®¡æ ¸',
                'approved': 'å·²é€šè¿‡',
                'needs_fix': 'éœ€ä¿®æ”¹',
                'rejected': 'å·²æ‹’ç»'
            };
            return map[status] || status;
        }
        
        // ========== ç¼–è¾‘åŠŸèƒ½ ==========
        
        // æ¨¡æ€æ¡†æ§åˆ¶
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // æ‰“å¼€ç¼–è¾‘å®ä½“æ¨¡æ€æ¡†
        function openEditEntityModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            const entity = currentEntityData.entity;
            document.getElementById('editEntityId').value = entity.identifier;
            document.getElementById('editEntityTitle').value = entity.title || '';
            document.getElementById('editEntityDescription').value = entity.description || '';
            document.getElementById('editEntityType').value = entity.type || '';
            
            openModal('editEntityModal');
        }
        
        // ä¿å­˜å®ä½“ç¼–è¾‘
        async function saveEntityEdit() {
            const identifier = document.getElementById('editEntityId').value;
            const updates = {
                title: document.getElementById('editEntityTitle').value,
                description: document.getElementById('editEntityDescription').value,
                type: document.getElementById('editEntityType').value
            };
            
            try {
                await api.edit.updateEntity(currentSubject, identifier, updates);
                showToast('å®ä½“æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editEntityModal');
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‰“å¼€æ·»åŠ å…³ç³»æ¨¡æ€æ¡†
        function openAddRelationModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            // é¢„å¡«æºå®ä½“
            document.getElementById('relationSource').value = currentEntityData.entity.identifier;
            document.getElementById('relationTarget').value = '';
            document.getElementById('relationLabel').value = '';
            
            openModal('addRelationModal');
        }
        
        // ä¿å­˜æ–°å…³ç³»
        async function saveNewRelation() {
            const relation = {
                source: document.getElementById('relationSource').value,
                target: document.getElementById('relationTarget').value,
                relation_name: document.getElementById('relationName').value,
                label: document.getElementById('relationLabel').value || null
            };
            
            if (!relation.source || !relation.target) {
                showToast('è¯·å¡«å†™æºå®ä½“å’Œç›®æ ‡å®ä½“', 'error');
                return;
            }
            
            try {
                await api.edit.createRelation(currentSubject, relation);
                showToast('å…³ç³»æ·»åŠ æˆåŠŸ', 'success');
                closeModal('addRelationModal');
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                const identifier = currentEntityData.entity.identifier;
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å…³ç³»ç›¸å…³
        let pendingDeleteRelation = null;
        
        function deleteRelation(index) {
            if (!currentEntityData || !currentEntityData.relations) {
                return;
            }
            
            const relation = currentEntityData.relations[index];
            pendingDeleteRelation = relation;
            
            document.getElementById('deleteConfirmText').textContent = 
                `ç¡®å®šè¦åˆ é™¤å…³ç³» "${relation.source_title} â†’ ${relation.relation_name} â†’ ${relation.target_title}" å—ï¼Ÿ`;
            
            openModal('confirmDeleteModal');
        }
        
        async function confirmDelete() {
            if (!pendingDeleteRelation) return;
            
            const relation = pendingDeleteRelation;
            
            try {
                await api.edit.deleteRelation(currentSubject, {
                    source: relation.source,
                    target: relation.target,
                    relation_name: relation.relation_name
                });
                
                showToast('å…³ç³»åˆ é™¤æˆåŠŸ', 'success');
                closeModal('confirmDeleteModal');
                pendingDeleteRelation = null;
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                const identifier = currentEntityData.entity.identifier;
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‰“å¼€å›¾è°±å¯è§†åŒ–æ¨¡æ€æ¡†
        async function openGraphModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            const entity = currentEntityData.entity;
            const container = document.getElementById('graphContainer');
            container.innerHTML = '<div class="empty-state">åŠ è½½å›¾è°±æ•°æ®ä¸­...</div>';
            
            // è®¾ç½®å…¨å±é“¾æ¥
            document.getElementById('graphFullLink').href = 
                `/static/index.html?subject=${currentSubject}&focus=${encodeURIComponent(entity.identifier)}`;
            
            openModal('graphModal');
            
            try {
                const graphData = await api.graph.getEntityGraph(currentSubject, entity.identifier, 2, 30);
                renderMiniGraph(container, graphData);
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“ç®€æ˜“å›¾è°±ï¼ˆä½¿ç”¨SVGï¼‰
        function renderMiniGraph(container, data) {
            if (!data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— å›¾è°±æ•°æ®</div>';
                return;
            }
            
            const width = container.clientWidth || 800;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // ç®€å•çš„åŠ›å¯¼å‘å¸ƒå±€æ¨¡æ‹Ÿ
            const nodes = data.nodes.map((node, i) => {
                const angle = (2 * Math.PI * i) / data.nodes.length;
                const radius = i === 0 ? 0 : 120 + Math.random() * 60;
                return {
                    ...node,
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });
            
            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);
            
            // ç”ŸæˆSVG
            let svg = `<svg width="${width}" height="${height}" style="font-family: sans-serif;">`;
            
            // ç»˜åˆ¶è¾¹
            if (data.edges) {
                data.edges.forEach(edge => {
                    const source = nodeMap[edge.source];
                    const target = nodeMap[edge.target];
                    if (source && target) {
                        svg += `<line x1="${source.x}" y1="${source.y}" x2="${target.x}" y2="${target.y}" 
                                stroke="#ccc" stroke-width="1"/>`;
                        // è¾¹æ ‡ç­¾
                        const midX = (source.x + target.x) / 2;
                        const midY = (source.y + target.y) / 2;
                        svg += `<text x="${midX}" y="${midY}" fill="#999" font-size="10" text-anchor="middle">${edge.label || ''}</text>`;
                    }
                });
            }
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            nodes.forEach((node, i) => {
                const isCenter = i === 0;
                const r = isCenter ? 25 : 18;
                const fill = isCenter ? '#1890ff' : '#52c41a';
                
                svg += `<circle cx="${node.x}" cy="${node.y}" r="${r}" fill="${fill}" stroke="white" stroke-width="2"/>`;
                svg += `<text x="${node.x}" y="${node.y + r + 15}" fill="#333" font-size="11" text-anchor="middle">${node.label || node.id}</text>`;
            });
            
            svg += '</svg>';
            container.innerHTML = svg;
        }
    </script>
</body>
</html>
