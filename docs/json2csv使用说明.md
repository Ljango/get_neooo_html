# JSON数据导出Excel工具使用说明

## 功能概述

`json2csv.py` 是一个用于将知识图谱JSON数据导出为Excel格式的工具，方便学科老师审核图谱数据的完整性和准确性。

## 功能特点

1. **实体数据导出**
   - 一个学科一个Excel文件
   - 每种实体类型一个sheet
   - 自动展开`contentJson`字段为`CJ_xxx`格式
   - 包含实体类型、名称、ID、描述等基础信息

2. **关系数据导出**
   - 一个学科一个Excel文件
   - 包含头尾节点的名称、类型、ID
   - 包含关系名称
   - 自动匹配节点信息

## 安装依赖

```bash
pip install pandas openpyxl
```

## 使用方法

### 基本用法

```bash
python3 json2csv.py <数据目录路径>
```

### 示例

```bash
# 导出高中数学数据
python3 json2csv.py "图谱数据/高中数学-with-books"

# 指定输出目录
python3 json2csv.py "图谱数据/高中数学-with-books" -o "导出数据"
```

### 参数说明

- `data_dir`: 数据目录路径（必须），应包含`entities`和`relations`子目录
- `-o, --output`: 输出目录路径（可选），默认为数据目录同级目录下的`导出数据`文件夹

## 输出文件格式

### 输出目录结构

```
导出数据/
├── 高中数学-with-books/
│   ├── 高中数学-with-books_实体数据.xlsx
│   ├── 高中数学-with-books_关系数据.xlsx
│   └── 高中数学-with-books_缺失节点日志.txt
├── 高中物理-with-books/
│   ├── 高中物理-with-books_实体数据.xlsx
│   ├── 高中物理-with-books_关系数据.xlsx
│   └── 高中物理-with-books_缺失节点日志.txt
...
```

每个学科的数据会导出到独立的文件夹中，包括：
- 实体数据Excel文件
- 关系数据Excel文件
- **缺失节点日志文件**（如果存在缺失节点）

### 实体数据Excel (`<学科名>_实体数据.xlsx`)

每个sheet对应一种实体类型，包含以下列：

| 列名 | 说明 |
|------|------|
| 实体类型 | 实体的类型（如Chapter、Unit等） |
| 实体名称 | 实体的title字段 |
| 实体ID | 实体的identifier字段 |
| 实体描述 | 实体的description字段 |
| CJ_xxx | contentJson中展开的字段（前缀CJ_） |
| 其他字段 | 实体中的其他属性 |

### 关系数据Excel (`<学科名>_关系数据.xlsx`)

**每个关系文件对应一个sheet**，每个sheet包含以下列：

| 列名 | 说明 |
|------|------|
| 头节点名称 | 源节点的title |
| 头节点类型 | 源节点的type |
| 头节点ID | 源节点的identifier |
| 尾节点名称 | 目标节点的title |
| 尾节点类型 | 目标节点的type |
| 尾节点ID | 目标节点的identifier |
| 关系名称 | 关系的relationName或label |
| 其他字段 | 关系中的其他属性（如evidence等） |

## 注意事项

1. **数据格式支持**
   - 支持实体文件为数组格式 `[{...}]` 或对象格式 `{"entities": [{...}]}`
   - 支持关系文件为数组格式或对象格式（`relations`、`relationships`、`relation`键）

2. **字符清理**
   - 自动清理Excel不支持的控制字符
   - 保留换行符和制表符

3. **缺失节点警告**
   - 如果关系中的节点identifier在实体中找不到，会显示警告
   - 缺失的节点名称和类型会显示为空

4. **Sheet名称限制**
   - Excel的sheet名称限制为31个字符，超长会自动截断
   - 关系文件的sheet名称基于文件名（不含扩展名）

5. **输出目录结构**
   - 每个学科的数据会导出到独立的文件夹中
   - 文件夹名称为学科目录名称
   - 便于管理和查找不同学科的数据

## 审核建议

### 实体数据审核要点

1. **完整性检查**
   - 检查每个实体的基本信息是否完整（名称、ID、描述）
   - 检查contentJson字段是否都正确展开

2. **准确性检查**
   - 检查实体名称是否正确
   - 检查实体描述是否准确
   - 检查contentJson中的字段值是否正确

3. **一致性检查**
   - 检查同一类型的实体格式是否一致
   - 检查identifier格式是否符合规范

### 关系数据审核要点

1. **完整性检查**
   - 检查每个关系的头尾节点是否都存在
   - 检查关系名称是否正确

2. **准确性检查**
   - 检查头尾节点的名称和类型是否匹配
   - 检查关系方向是否正确
   - 检查是否有重复或错误的关系

3. **逻辑性检查**
   - 检查关系是否符合知识图谱的逻辑
   - 检查是否有缺失的重要关系

## 示例输出

```
============================================================
📊 JSON数据导出工具
   数据目录: 图谱数据/高中数学-with-books
   输出目录: 图谱数据/导出数据
============================================================

📂 找到 11 个实体文件
  ✓ Domain.json: 4 个 Domain
  ✓ CoreLiteracy.json: 18 个 CoreLiteracy
  ...

📊 总计加载 403 个实体，403 个identifier映射

📝 导出实体数据到: 图谱数据/导出数据/高中数学-with-books_实体数据.xlsx
  处理 AcademicQuality: 3 个实体
  ...

✅ 实体数据导出完成

📂 找到 12 个关系文件
  ✓ Chaptert_Section.json: 128 个关系
  ...

📊 总计加载 2746 个关系

📝 导出关系数据到: 图谱数据/导出数据/高中数学-with-books_关系数据.xlsx
✅ 关系数据导出完成

============================================================
✅ 导出完成！
============================================================
```

## 缺失节点日志

如果关系数据中存在找不到对应实体信息的节点，脚本会自动生成详细的日志文件 `<学科名>_缺失节点日志.txt`。

### 日志文件内容

日志文件包含以下信息：

1. **统计摘要**
   - 缺失头节点总数
   - 缺失尾节点总数
   - 涉及的关系文件数
   - 涉及的关系总数

2. **按关系文件分组**
   - 列出每个关系文件中缺失的节点
   - 显示具体的行号、节点位置（头/尾）、节点ID、关系名称

3. **按缺失节点ID汇总**
   - 列出所有缺失的节点ID
   - 显示每个节点出现在哪些关系文件的哪些关系中

4. **排查建议**
   - 提供排查步骤和建议

### 日志文件示例

```
================================================================================
缺失节点信息日志 - 高中数学-with-books
生成时间: 2026-01-22 11:05:08
================================================================================

【统计摘要】
  缺失头节点总数: 3
  缺失尾节点总数: 1
  涉及的关系文件数: 3
  涉及的关系总数: 9

【按关系文件分组】
文件: CourseModuke_Theme_Relations.json
  缺失头节点 (3 个):
    行号    7 | 节点位置: 头节点    | 节点ID: urn:jy:math:SB0201:OB06:course-module:cm004
            | 关系名称: courseModuleHasTheme
            | 尾节点ID: urn:jy:math:SB0201:OB06:theme:th007
...

【按缺失节点ID汇总】
缺失的头节点ID列表:
  urn:jy:math:SB0201:OB06:KeyPoint:kp00030
    出现在 3 个关系中:
      - KeyPoint_Unit_relations.json (行号 53, 关系: keyPointBelongsToUnit)
...
```

### 使用日志排查问题

1. **查看统计摘要**：了解缺失节点的总体情况
2. **按文件分组查看**：快速定位哪些关系文件有问题
3. **按节点ID汇总**：找出缺失的节点，检查实体文件中是否存在
4. **检查identifier匹配**：确保关系文件中的identifier与实体文件完全一致（大小写、空格、特殊字符）

## 常见问题

### Q: 提示"实体目录不存在"
A: 检查数据目录路径是否正确，确保包含`entities`子目录

### Q: 提示"关系目录不存在"
A: 检查数据目录路径是否正确，确保包含`relations`或`relation`子目录

### Q: 导出的Excel文件打不开
A: 可能是文件损坏，检查是否有足够的磁盘空间，重新运行导出

### Q: 某些节点名称显示为空
A: 检查关系文件中的identifier是否与实体文件中的identifier完全匹配（包括大小写），查看缺失节点日志文件获取详细信息

### Q: 如何排查缺失节点问题
A: 查看生成的缺失节点日志文件，按照日志中的排查建议逐步检查：
1. 检查entities目录中是否存在对应的实体文件
2. 检查实体文件中的identifier字段是否与关系文件中的source/target完全匹配
3. 注意identifier的大小写、空格、特殊字符等细节
4. 检查是否有实体文件格式错误（JSON解析失败）
5. 检查是否有实体文件被遗漏未加载

## 更新日志

- v1.0.0 (2025-01-22)
  - 初始版本
  - 支持实体和关系数据导出
  - 支持contentJson字段展开
  - 自动清理非法字符
