<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item active" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item" data-role="root">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">ç”¨æˆ·ç®¡ç†</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showCreateUserModal()">æ·»åŠ ç”¨æˆ·</button>
                </div>
            </header>
            
            <main class="content">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="stats-grid" id="statsGrid"></div>
                
                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        ç”¨æˆ·åˆ—è¡¨
                        <select id="roleFilter" onchange="loadUsers()" style="padding: 5px 10px; border-radius: 4px;">
                            <option value="">å…¨éƒ¨è§’è‰²</option>
                            <option value="root">ç³»ç»Ÿç®¡ç†å‘˜</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="engineer">å›¾è°±å·¥ç¨‹å¸ˆ</option>
                            <option value="teacher">æ•™å¸ˆ</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·å</th>
                                        <th>å§“å</th>
                                        <th>è§’è‰²</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è´Ÿè´£å­¦ç§‘</th>
                                        <th>æœ€åç™»å½•</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pagination"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3>æ·»åŠ ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" name="password" required minlength="6" placeholder="è‡³å°‘6ä½">
                    </div>
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 15px; padding: 10px 0;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="roles" value="teacher" checked> æ•™å¸ˆ
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="roles" value="engineer"> å›¾è°±å·¥ç¨‹å¸ˆ
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="roles" value="admin"> ç®¡ç†å‘˜
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" name="email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('createUserModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createUser()">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘è§’è‰²æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editRolesModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç”¨æˆ·è§’è‰²</h3>
                <button class="modal-close" onclick="closeModal('editRolesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="editRolesUserName" style="margin-bottom: 15px; font-weight: bold;"></p>
                <div class="form-group">
                    <label>è§’è‰²ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div id="editRolesCheckboxes" class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 15px; padding: 10px 0;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" name="editRoles" value="teacher"> æ•™å¸ˆ
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" name="editRoles" value="engineer"> å›¾è°±å·¥ç¨‹å¸ˆ
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" name="editRoles" value="admin"> ç®¡ç†å‘˜
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editRolesModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUserRoles()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ†é…å­¦ç§‘æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="assignModal">
        <div class="modal">
            <div class="modal-header">
                <h3>åˆ†é…å­¦ç§‘</h3>
                <button class="modal-close" onclick="closeModal('assignModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="assignUserName" style="margin-bottom: 15px;"></p>
                <div class="form-group">
                    <label>é€‰æ‹©å­¦ç§‘</label>
                    <select id="assignSubjectSelect">
                        <option value="">è¯·é€‰æ‹©å­¦ç§‘</option>
                    </select>
                </div>
                <div id="currentAssignments" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('assignModal')">å…³é—­</button>
                <button class="btn btn-primary" onclick="assignSubject()">åˆ†é…</button>
            </div>
        </div>
    </div>
    
    <div class="toast-container"></div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥æƒé™
        if (!requireRole('root', 'admin')) {
            // è‡ªåŠ¨è·³è½¬
        }
        
        initPage();
        
        let currentPage = 1;
        let currentUserId = null;
        let subjectsList = [];
        
        // åŠ è½½æ•°æ®
        loadStats();
        loadUsers();
        loadSubjectsList();
        
        async function loadStats() {
            try {
                const stats = await api.admin.getStatistics();
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_subjects}</div>
                        <div class="stat-label">å­¦ç§‘æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_entities.toLocaleString()}</div>
                        <div class="stat-label">æ€»å®ä½“æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_reviewed}</div>
                        <div class="stat-label">å·²å®¡æ ¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_approved}</div>
                        <div class="stat-label">å·²é€šè¿‡</div>
                    </div>
                `;
            } catch (e) {
                console.error('Load stats error:', e);
            }
        }
        
        async function loadUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const tbody = document.getElementById('userTableBody');
            
            try {
                // æ„å»ºå‚æ•°å¯¹è±¡ï¼ŒåªåŒ…å«æœ‰æ•ˆå€¼
                const params = { 
                    page: currentPage
                };
                
                // åªæœ‰å½“ roleFilter ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ åˆ°å‚æ•°ä¸­
                if (roleFilter) {
                    params.role_filter = roleFilter;
                }
                
                const result = await api.admin.getUsers(params);
                
                if (result.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                // è·å–æ¯ä¸ªç”¨æˆ·çš„å­¦ç§‘åˆ†é…
                const usersWithSubjects = await Promise.all(
                    result.users.map(async (user) => {
                        try {
                            const detail = await api.admin.getUser(user.id);
                            return { ...user, subjects: detail.user.subjects || [] };
                        } catch (e) {
                            return { ...user, subjects: [] };
                        }
                    })
                );
                
                tbody.innerHTML = usersWithSubjects.map(u => {
                    const roles = u.roles || [u.role];
                    const isRoot = roles.includes('root');
                    const rolesJson = JSON.stringify(roles).replace(/"/g, '&quot;');
                    return `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.name}</td>
                        <td>${displayRoles(u)}</td>
                        <td>${u.is_active ? 'âœ… æ­£å¸¸' : 'âŒ ç¦ç”¨'}</td>
                        <td>${u.subjects.map(s => s.subject_id).join(', ') || '-'}</td>
                        <td>${u.last_login ? new Date(u.last_login).toLocaleString() : '-'}</td>
                        <td>
                            ${!isRoot ? `<button class="btn" onclick="showEditRolesModal(${u.id}, '${u.name}', ${rolesJson})" style="padding:4px 8px;font-size:12px;">ç¼–è¾‘è§’è‰²</button>` : ''}
                            <button class="btn btn-primary" onclick="showAssignModal(${u.id}, '${u.name}')" style="padding:4px 8px;font-size:12px;">åˆ†é…å­¦ç§‘</button>
                            <button class="btn btn-warning" onclick="resetPassword(${u.id})" style="padding:4px 8px;font-size:12px;">é‡ç½®å¯†ç </button>
                            ${!isRoot ? `<button class="btn btn-danger" onclick="toggleUserStatus(${u.id}, ${u.is_active})" style="padding:4px 8px;font-size:12px;">${u.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>` : ''}
                        </td>
                    </tr>
                    `;
                }).join('');
                
                renderPagination(result.total);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        async function loadSubjectsList() {
            try {
                const result = await api.review.getSubjects();
                subjectsList = result.subjects;
                
                const select = document.getElementById('assignSubjectSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦ç§‘</option>';
                subjectsList.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Load subjects error:', e);
            }
        }
        
        function renderPagination(total) {
            const pageSize = 20;
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>
                <span style="padding: 8px;">${currentPage} / ${totalPages}</span>
                <button ${currentPage >= totalPages ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>
            `;
        }
        
        function goPage(page) {
            currentPage = page;
            loadUsers();
        }
        
        function showCreateUserModal() {
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserModal').classList.add('active');
        }
        
        async function showAssignModal(userId, userName) {
            currentUserId = userId;
            document.getElementById('assignUserName').textContent = `ç”¨æˆ·ï¼š${userName}`;
            document.getElementById('assignSubjectSelect').value = '';
            
            // åŠ è½½å½“å‰åˆ†é…
            try {
                const detail = await api.admin.getUser(userId);
                const assignments = detail.user.subjects || [];
                
                document.getElementById('currentAssignments').innerHTML = assignments.length > 0
                    ? `<p>å·²åˆ†é…å­¦ç§‘ï¼š</p><ul>${assignments.map(a => 
                        `<li>${a.subject_id} <button onclick="removeAssignment(${a.id})" style="color:red;border:none;background:none;cursor:pointer;">Ã—</button></li>`
                      ).join('')}</ul>`
                    : '<p style="color:#999;">å°šæœªåˆ†é…å­¦ç§‘</p>';
            } catch (e) {
                document.getElementById('currentAssignments').innerHTML = '';
            }
            
            document.getElementById('assignModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        async function createUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            
            // è·å–é€‰ä¸­çš„è§’è‰²ï¼ˆå¤šé€‰ï¼‰
            const selectedRoles = formData.getAll('roles');
            if (selectedRoles.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²', 'warning');
                return;
            }
            
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                name: formData.get('name'),
                roles: selectedRoles,
                email: formData.get('email') || null
            };
            
            try {
                await api.admin.createUser(data);
                showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                closeModal('createUserModal');
                loadUsers();
            } catch (error) {
                showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function assignSubject() {
            const subjectId = document.getElementById('assignSubjectSelect').value;
            if (!subjectId || !currentUserId) {
                showToast('è¯·é€‰æ‹©å­¦ç§‘', 'warning');
                return;
            }
            
            try {
                await api.admin.assignSubject({
                    user_id: currentUserId,
                    subject_id: subjectId
                });
                showToast('åˆ†é…æˆåŠŸ', 'success');
                showAssignModal(currentUserId, document.getElementById('assignUserName').textContent.replace('ç”¨æˆ·ï¼š', ''));
                loadUsers();
            } catch (error) {
                showToast('åˆ†é…å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function removeAssignment(assignmentId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤å­¦ç§‘åˆ†é…å—ï¼Ÿ')) return;
            
            try {
                await api.admin.removeAssignment(assignmentId);
                showToast('å·²ç§»é™¤', 'success');
                showAssignModal(currentUserId, document.getElementById('assignUserName').textContent.replace('ç”¨æˆ·ï¼š', ''));
                loadUsers();
            } catch (error) {
                showToast('ç§»é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function resetPassword(userId) {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ­¤ç”¨æˆ·çš„å¯†ç å—ï¼Ÿ')) return;
            
            try {
                const result = await api.admin.resetPassword(userId);
                showToast(result.message, 'success');
            } catch (error) {
                showToast('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'ç¦ç”¨' : 'å¯ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}æ­¤ç”¨æˆ·å—ï¼Ÿ`)) return;
            
            try {
                await api.admin.updateUser(userId, { is_active: !currentStatus });
                showToast(`å·²${action}`, 'success');
                loadUsers();
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function getRoleText(role) {
            const map = {
                'root': 'ç³»ç»Ÿç®¡ç†å‘˜',
                'admin': 'ç®¡ç†å‘˜',
                'engineer': 'å›¾è°±å·¥ç¨‹å¸ˆ',
                'teacher': 'æ•™å¸ˆ'
            };
            return map[role] || role;
        }
        
        // æ˜¾ç¤ºç”¨æˆ·è§’è‰²ï¼ˆæ”¯æŒå¤šè§’è‰²ï¼‰
        function displayRoles(user) {
            // ä¼˜å…ˆä½¿ç”¨ roles æ•°ç»„
            const roles = user.roles || [user.role];
            return roles.map(r => `<span class="badge badge-${r}">${getRoleText(r)}</span>`).join(' ');
        }
        
        // æ˜¾ç¤ºç¼–è¾‘è§’è‰²æ¨¡æ€æ¡†
        let editingUserId = null;
        function showEditRolesModal(userId, userName, currentRoles) {
            editingUserId = userId;
            document.getElementById('editRolesUserName').textContent = `ç”¨æˆ·ï¼š${userName}`;
            
            // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†
            const checkboxes = document.querySelectorAll('input[name="editRoles"]');
            checkboxes.forEach(cb => {
                cb.checked = currentRoles.includes(cb.value);
            });
            
            document.getElementById('editRolesModal').classList.add('active');
        }
        
        // ä¿å­˜ç”¨æˆ·è§’è‰²
        async function saveUserRoles() {
            if (!editingUserId) return;
            
            const checkboxes = document.querySelectorAll('input[name="editRoles"]:checked');
            const selectedRoles = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedRoles.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²', 'warning');
                return;
            }
            
            try {
                await api.admin.updateUser(editingUserId, { roles: selectedRoles });
                showToast('è§’è‰²æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editRolesModal');
                loadUsers();
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
