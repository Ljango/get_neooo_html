<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å®¡æ ¸ - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <style>
        /* å­¦ç§‘é€‰æ‹©å™¨æ ·å¼ - æ›´åŠ æ˜¾çœ¼ */
        .subject-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .subject-selector-label {
            color: white;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .subject-selector-label::before {
            content: "ğŸ“š";
            font-size: 24px;
        }
        
        .subject-selector select {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #fff;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .subject-selector select:hover {
            border-color: #a8b5ff;
            box-shadow: 0 0 0 3px rgba(168, 181, 255, 0.2);
        }
        
        .subject-selector select:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.3);
        }
        
        .review-layout {
            display: flex;
            gap: 20px;
            height: calc(100vh - 100px);
        }
        
        .list-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }
        
        .entity-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-light);
        }
        
        .entity-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .entity-item:hover {
            background: #f5f7fa;
        }
        
        .entity-item.active {
            background: #e6f4ff;
            border-left: 3px solid var(--primary-color);
        }
        
        .entity-item .title {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .entity-item .meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* æ°´å¹³/ç­‰çº§æ ‡ç­¾æ ·å¼ */
        .level-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            white-space: nowrap;
        }
        
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-light);
            border-radius: var(--radius);
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .property-list {
            display: grid;
            gap: 10px;
        }
        
        .property-item {
            display: flex;
        }
        
        .property-item .label {
            width: 100px;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        
        .property-item .value {
            flex: 1;
        }
        
        .relation-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .relation-item {
            padding: 10px;
            background: var(--bg-color);
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* å®¡æ ¸æ“ä½œåŒºåŸŸ - é†’ç›®æ ·å¼ */
        .review-actions {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #e8f4fd 0%, #d4e8f8 100%);
            border: 2px solid #1890ff;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.15);
        }
        
        .review-actions textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #91caff;
            border-radius: var(--radius);
            resize: none;
            height: 50px;
            font-size: 14px;
        }
        
        .review-actions textarea:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .review-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .review-buttons .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* å¯æŠ˜å å†…å®¹æ ·å¼ */
        .collapsible-section h3 {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .collapsible-section h3:hover {
            color: var(--primary-color);
        }
        
        .collapsible-section h3 .toggle-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .collapsible-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .collapsible-section.collapsed .collapsible-content {
            display: none;
        }
        
        .json-content {
            background: #f6f8fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .extra-field {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .extra-field:last-child {
            border-bottom: none;
        }
        
        .extra-field .field-name {
            color: #1890ff;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .extra-field .field-value {
            color: var(--text-color);
        }
        
        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: var(--bg-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* ç¼–è¾‘åŠŸèƒ½æ ·å¼ */
        .edit-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f7ff;
            border-radius: var(--radius);
            border: 1px solid #d0e3ff;
        }
        
        .edit-toolbar .btn {
            font-size: 13px;
            padding: 6px 12px;
        }
        
        .btn-edit {
            background: #1890ff;
            color: white;
            border: none;
        }
        
        .btn-edit:hover {
            background: #40a9ff;
        }
        
        .btn-graph {
            background: #52c41a;
            color: white;
            border: none;
        }
        
        .btn-graph:hover {
            background: #73d13d;
        }
        
        .btn-add-relation {
            background: #722ed1;
            color: white;
            border: none;
        }
        
        .btn-add-relation:hover {
            background: #9254de;
        }
        
        .btn-undo {
            background: #fa8c16;
            color: white;
            border: none;
        }
        
        .btn-undo:hover {
            background: #ffa940;
        }
        
        .relation-item {
            position: relative;
            padding-right: 40px;
        }
        
        .relation-item .delete-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .relation-item .delete-btn:hover {
            opacity: 1;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* å›¾è°±å¯è§†åŒ–å®¹å™¨ */
        .graph-container {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: #fafafa;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item active">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item" data-role="root">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">æ•°æ®å®¡æ ¸</h1>
            </header>
            
            <main class="content">
                <!-- å­¦ç§‘é€‰æ‹©å™¨ - æ˜¾çœ¼ä½ç½® -->
                <div class="subject-selector">
                    <div class="subject-selector-label">è¯·é€‰æ‹©è¦å®¡æ ¸çš„å­¦ç§‘</div>
                    <select id="subjectSelect" onchange="onSubjectChange()">
                        <option value="">è¯·é€‰æ‹©å­¦ç§‘...</option>
                    </select>
                </div>
                
                <div class="review-layout">
                    <!-- åˆ—è¡¨é¢æ¿ -->
                    <div class="list-panel">
                        <div class="tab-bar">
                            <button class="tab-btn active" data-type="entity" onclick="switchTab('entity')">å®ä½“</button>
                            <button class="tab-btn" data-type="relation" onclick="switchTab('relation')">å…³ç³»</button>
                        </div>
                        
                        <div class="filter-bar">
                            <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜/æ ‡è¯†ç¬¦..." 
                                   style="flex: 1; min-width: 150px;" 
                                   onkeyup="handleSearchInput(event)">
                            <select id="statusFilter" onchange="loadList()">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="pending">å¾…å®¡æ ¸</option>
                                <option value="approved">å·²é€šè¿‡</option>
                                <option value="needs_fix">éœ€ä¿®æ”¹</option>
                            </select>
                            <select id="typeFilter" onchange="loadList()">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                            </select>
                        </div>
                        
                        <div class="entity-list" id="itemList">
                            <div class="empty-state">è¯·å…ˆé€‰æ‹©å­¦ç§‘</div>
                        </div>
                        
                        <div class="pagination" id="pagination"></div>
                    </div>
                    
                    <!-- è¯¦æƒ…é¢æ¿ -->
                    <div class="detail-panel">
                        <!-- å®¡æ ¸æ“ä½œåŒºåŸŸ - ç§»åˆ°é¡¶éƒ¨æ›´æ˜¾çœ¼ -->
                        <div class="review-actions" id="reviewActions" style="display: none;">
                            <textarea id="reviewComment" placeholder="å®¡æ ¸æ„è§ï¼ˆå¯é€‰ï¼‰"></textarea>
                            <div class="review-buttons">
                                <button class="btn btn-success" onclick="submitReview('approved')">âœ“ é€šè¿‡</button>
                                <button class="btn btn-warning" onclick="submitReview('needs_fix')">âœ éœ€ä¿®æ”¹</button>
                            </div>
                        </div>
                        
                        <div class="detail-content" id="detailContent">
                            <div class="empty-state">é€‰æ‹©å·¦ä¾§é¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="toast-container"></div>
    
    <!-- å®ä½“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editEntityModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ç¼–è¾‘å®ä½“å±æ€§</h3>
                <button class="modal-close" onclick="closeModal('editEntityModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="editEntityForm">
                    <div class="form-group">
                        <label>æ ‡è¯†ç¬¦ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                        <input type="text" id="editEntityId" disabled style="background:#f5f5f5;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>æ ‡é¢˜</label>
                            <input type="text" id="editEntityTitle" required>
                        </div>
                        <div class="form-group">
                            <label>ç±»å‹</label>
                            <input type="text" id="editEntityType">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="editEntityDescription" style="height: 100px;"></textarea>
                    </div>
                    <!-- åŠ¨æ€ç”Ÿæˆçš„é¢å¤–å­—æ®µ -->
                    <div id="editExtraFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editEntityModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEntityEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ å…³ç³»æ¨¡æ€æ¡† -->
    <div class="modal" id="addRelationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ å…³ç³»</h3>
                <button class="modal-close" onclick="closeModal('addRelationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addRelationForm">
                    <div class="form-group">
                        <label>æºå®ä½“</label>
                        <input type="text" id="relationSource" required>
                    </div>
                    <div class="form-group">
                        <label>å…³ç³»ç±»å‹</label>
                        <select id="relationName" required>
                            <option value="åŒ…å«">åŒ…å«</option>
                            <option value="å±äº">å±äº</option>
                            <option value="ç›¸å…³">ç›¸å…³</option>
                            <option value="å‰ç½®">å‰ç½®</option>
                            <option value="åç»­">åç»­</option>
                            <option value="ä¾èµ–">ä¾èµ–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡å®ä½“</label>
                        <input type="text" id="relationTarget" required>
                    </div>
                    <div class="form-group">
                        <label>æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="relationLabel">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addRelationModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNewRelation()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- å›¾è°±å¯è§†åŒ–æ¨¡æ€æ¡† -->
    <div class="modal" id="graphModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>å›¾è°±å¯è§†åŒ–</h3>
                <button class="modal-close" onclick="closeModal('graphModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="graph-container" id="graphContainer">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('graphModal')">å…³é—­</button>
                <a id="graphFullLink" href="#" target="_blank" class="btn btn-primary">å…¨å±æŸ¥çœ‹</a>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="closeModal('confirmDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³ç³»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('confirmDeleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- å…³ç³»ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editRelationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ç¼–è¾‘å…³ç³»æ ‡ç­¾</h3>
                <button class="modal-close" onclick="closeModal('editRelationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editRelationForm">
                    <div class="form-group">
                        <label>å…³ç³»</label>
                        <input type="text" id="editRelationInfo" disabled style="background:#f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>æ ‡ç­¾/å¤‡æ³¨</label>
                        <textarea id="editRelationLabel" placeholder="è¾“å…¥å…³ç³»çš„æ ‡ç­¾æˆ–å¤‡æ³¨ä¿¡æ¯..." style="height: 100px;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editRelationModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRelationEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ’¤é”€æ“ä½œæ¨¡æ€æ¡† -->
    <div class="modal" id="undoModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>æ’¤é”€æ“ä½œ</h3>
                <button class="modal-close" onclick="closeModal('undoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ç‰ˆæœ¬ã€‚æ¯æ¬¡ç¼–è¾‘æ“ä½œéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œå¯ä»¥æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚</p>
                <div id="undoHistoryList" style="max-height: 400px; overflow-y: auto;">
                    <div class="empty-state">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('undoModal')">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        if (!requireAuth()) {
            // è‡ªåŠ¨è·³è½¬
        }
        
        initPage();
        
        // çŠ¶æ€
        let currentSubject = null;
        let currentTab = 'entity';
        let currentItem = null;
        let currentPage = 1;
        const pageSize = 50;
        
        // ä»URLè·å–å­¦ç§‘å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const urlSubject = urlParams.get('subject');
        
        // åŠ è½½å­¦ç§‘åˆ—è¡¨
        loadSubjects();
        
        async function loadSubjects() {
            try {
                const result = await api.review.getSubjects();
                const select = document.getElementById('subjectSelect');
                
                result.subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
                
                // å¦‚æœURLæœ‰å­¦ç§‘å‚æ•°ï¼Œè‡ªåŠ¨é€‰æ‹©
                if (urlSubject) {
                    select.value = urlSubject;
                    onSubjectChange();
                }
                
                select.addEventListener('change', onSubjectChange);
            } catch (error) {
                showToast('åŠ è½½å­¦ç§‘åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        function onSubjectChange() {
            currentSubject = document.getElementById('subjectSelect').value;
            currentPage = 1;
            currentItem = null;
            
            if (currentSubject) {
                loadTypeFilter();
                loadList();
            } else {
                document.getElementById('itemList').innerHTML = '<div class="empty-state">è¯·å…ˆé€‰æ‹©å­¦ç§‘</div>';
            }
            
            clearDetail();
        }
        
        // é˜²æ­¢å¹¶å‘è°ƒç”¨
        let loadTypeFilterPromise = null;
        
        async function loadTypeFilter() {
            // å¦‚æœå·²æœ‰è¯·æ±‚åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾…å®ƒå®Œæˆ
            if (loadTypeFilterPromise) {
                await loadTypeFilterPromise;
                return;
            }
            
            // åŠ è½½å®ä½“ç±»å‹ç”¨äºç­›é€‰ï¼ˆä½¿ç”¨ä¸“ç”¨APIè·å–æ‰€æœ‰ç±»å‹ï¼‰
            const typeSelect = document.getElementById('typeFilter');
            typeSelect.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>';
            
            if (currentTab === 'entity' && currentSubject) {
                loadTypeFilterPromise = (async () => {
                    try {
                        const result = await api.review.getEntityTypes(currentSubject);
                        if (result.success && result.types) {
                            // ä½¿ç”¨Setå»é‡
                            const addedTypes = new Set();
                            result.types.forEach(item => {
                                if (!addedTypes.has(item.type)) {
                                    addedTypes.add(item.type);
                                    const option = document.createElement('option');
                                    option.value = item.type;
                                    option.textContent = `${item.type} (${item.count})`;
                                    typeSelect.appendChild(option);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('åŠ è½½å®ä½“ç±»å‹å¤±è´¥:', e);
                    } finally {
                        loadTypeFilterPromise = null;
                    }
                })();
                await loadTypeFilterPromise;
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;
            currentItem = null;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === tab);
            });
            
            loadTypeFilter();
            loadList();
            clearDetail();
        }
        
        // æœç´¢é˜²æŠ–å¤„ç†
        let searchTimeout = null;
        function handleSearchInput(event) {
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // å¦‚æœæŒ‰ä¸‹å›è½¦ï¼Œç«‹å³æœç´¢
            if (event.key === 'Enter') {
                currentPage = 1;
                loadList();
                return;
            }
            
            // å¦åˆ™å»¶è¿Ÿ300msåæœç´¢ï¼ˆé˜²æŠ–ï¼‰
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadList();
            }, 300);
        }
        
        async function loadList() {
            if (!currentSubject) return;
            
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchValue = document.getElementById('searchInput').value.trim();
            const listContainer = document.getElementById('itemList');
            
            listContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                let result;
                const params = {
                    page: currentPage,
                    page_size: pageSize,
                    status_filter: statusFilter || undefined,
                    entity_type: typeFilter || undefined,
                    search: searchValue || undefined
                };
                
                // æ¸…ç†undefinedå‚æ•°
                Object.keys(params).forEach(k => params[k] === undefined && delete params[k]);
                
                if (currentTab === 'entity') {
                    result = await api.review.getEntities(currentSubject, params);
                    renderEntityList(result.entities, result.total);
                } else {
                    result = await api.review.getRelations(currentSubject, params);
                    renderRelationList(result.relations, result.total);
                }
                
                renderPagination(result.total);
            } catch (error) {
                listContainer.innerHTML = `<div class="empty-state" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function renderEntityList(entities, total) {
            const container = document.getElementById('itemList');
            
            if (entities.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = entities.map(e => `
                <div class="entity-item" onclick="selectEntity('${encodeURIComponent(e.identifier)}')" data-id="${e.identifier}">
                    <div class="title">
                        ${e.title || e.identifier}
                        ${e.level ? `<span class="level-badge">${e.level}</span>` : ''}
                    </div>
                    <div class="meta">
                        <span>${e.type}</span>
                        ${e.review_status ? `<span class="badge badge-${e.review_status}">${getStatusText(e.review_status)}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function renderRelationList(relations, total) {
            const container = document.getElementById('itemList');
            
            if (relations.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = relations.map((r, idx) => `
                <div class="entity-item" onclick="selectRelation(${idx})" data-index="${idx}">
                    <div class="title">${r.source_title} â†’ ${r.target_title}</div>
                    <div class="meta">
                        <span>${r.relation_name}</span>
                        ${r.review_status ? `<span class="badge badge-${r.review_status}">${getStatusText(r.review_status)}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            // ä¿å­˜å…³ç³»æ•°æ®
            window._relations = relations;
        }
        
        function renderPagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            html += `<span style="padding: 8px;">${currentPage} / ${totalPages}</span>`;
            html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            container.innerHTML = html;
        }
        
        function goPage(page) {
            currentPage = page;
            loadList();
        }
        
        async function selectEntity(identifier) {
            // é«˜äº®é€‰ä¸­é¡¹
            document.querySelectorAll('.entity-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === decodeURIComponent(identifier));
            });
            
            try {
                const result = await api.review.getEntityDetail(currentSubject, decodeURIComponent(identifier));
                currentItem = {
                    type: 'entity',
                    id: result.entity.identifier,
                    title: result.entity.title,
                    entityType: result.entity.type,
                    index: result.entity.identifier  // ç”¨äºå®šä½
                };
                renderEntityDetail(result);
                document.getElementById('reviewActions').style.display = 'flex';
            } catch (error) {
                showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
            }
        }
        
        function selectRelation(index) {
            const relation = window._relations[index];
            
            // é«˜äº®é€‰ä¸­é¡¹
            document.querySelectorAll('.entity-item').forEach(el => {
                el.classList.toggle('active', el.dataset.index === String(index));
            });
            
            currentItem = {
                type: 'relation',
                id: `${relation.source}|${relation.target}|${relation.relation_name}`,
                title: `${relation.source_title} â†’ ${relation.target_title}`,
                index: index  // ç”¨äºå®šä½
            };
            
            renderRelationDetail(relation);
            document.getElementById('reviewActions').style.display = 'flex';
        }
        
        // ä¿å­˜å½“å‰å®ä½“æ•°æ®ç”¨äºç¼–è¾‘
        let currentEntityData = null;
        
        function renderEntityDetail(data) {
            const content = document.getElementById('detailContent');
            const entity = data.entity;
            
            // ä¿å­˜å½“å‰å®ä½“æ•°æ®
            currentEntityData = data;
            
            // åŸºç¡€å­—æ®µåˆ—è¡¨
            const basicFields = ['identifier', 'type', 'title', 'description', 'subject', '_entity_type'];
            
            // è·å–é¢å¤–å­—æ®µ
            const extraFields = Object.keys(entity).filter(k => !basicFields.includes(k));
            
            // æ¸²æŸ“é¢å¤–å­—æ®µçš„HTML
            let extraFieldsHtml = '';
            if (extraFields.length > 0) {
                const fieldsContent = extraFields.map(field => {
                    const value = entity[field];
                    let displayValue;
                    
                    if (value === null || value === undefined) {
                        displayValue = '<span style="color:#999;">-</span>';
                    } else if (typeof value === 'object') {
                        displayValue = `<div class="json-content">${JSON.stringify(value, null, 2)}</div>`;
                    } else {
                        displayValue = `<span>${value}</span>`;
                    }
                    
                    return `
                        <div class="extra-field">
                            <div class="field-name">${field}</div>
                            <div class="field-value">${displayValue}</div>
                        </div>
                    `;
                }).join('');
                
                extraFieldsHtml = `
                <div class="detail-section collapsible-section">
                    <h3 onclick="toggleCollapsible(this.parentElement)">
                        å…¶ä»–å±æ€§ (${extraFields.length})
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="collapsible-content">
                        ${fieldsContent}
                    </div>
                </div>
                `;
            }
            
            content.innerHTML = `
                <!-- ç¼–è¾‘å·¥å…·æ  -->
                <div class="edit-toolbar">
                    <button class="btn btn-edit" onclick="openEditEntityModal()">
                        âœï¸ ç¼–è¾‘å±æ€§
                    </button>
                    <button class="btn btn-add-relation" onclick="openAddRelationModal()">
                        â• æ·»åŠ å…³ç³»
                    </button>
                    <button class="btn btn-graph" onclick="openGraphModal()">
                        ğŸ”— æŸ¥çœ‹å›¾è°±
                    </button>
                    <button class="btn btn-undo" onclick="openUndoModal()">
                        â†©ï¸ æ’¤é”€æ“ä½œ
                    </button>
                </div>
                
                <div class="detail-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">æ ‡è¯†ç¬¦</span>
                            <span class="value" style="word-break:break-all;">${entity.identifier}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">ç±»å‹</span>
                            <span class="value">${entity.type}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æ ‡é¢˜</span>
                            <span class="value">${entity.title || '-'}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æè¿°</span>
                            <span class="value">${entity.description || '-'}</span>
                        </div>
                        ${entity.content_json && entity.content_json.standard ? `
                        <div class="property-item">
                            <span class="label">æ°´å¹³/ç­‰çº§</span>
                            <span class="value"><span class="level-badge" style="font-size: 13px; padding: 4px 10px;">${entity.content_json.standard}</span></span>
                        </div>
                        ` : ''}
                        ${entity.subject ? `
                        <div class="property-item">
                            <span class="label">å­¦ç§‘</span>
                            <span class="value">${entity.subject}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${extraFieldsHtml}
                
                ${data.relations && data.relations.length > 0 ? `
                <div class="detail-section">
                    <h3>å…³è”å…³ç³» (${data.relations.length})</h3>
                    <div class="relation-list">
                        ${data.relations.map((r, idx) => `
                            <div class="relation-item">
                                ${r.direction === 'outgoing' ? 'â†’' : 'â†'} 
                                <strong>${r.relation_name}</strong>: 
                                ${r.direction === 'outgoing' ? r.target_title : r.source_title}
                                <button class="delete-btn" onclick="deleteRelation(${idx})">åˆ é™¤</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="detail-section">
                    <h3>å…³è”å…³ç³»</h3>
                    <div class="empty-state" style="padding: 20px;">æš‚æ— å…³è”å…³ç³»</div>
                </div>
                `}
                
                ${data.review ? `
                <div class="detail-section">
                    <h3>å®¡æ ¸è®°å½•</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">çŠ¶æ€</span>
                            <span class="value"><span class="badge badge-${data.review.status}">${getStatusText(data.review.status)}</span></span>
                        </div>
                        <div class="property-item">
                            <span class="label">å®¡æ ¸äºº</span>
                            <span class="value">${data.review.reviewer || '-'}</span>
                        </div>
                        <div class="property-item">
                            <span class="label">æ„è§</span>
                            <span class="value">${data.review.comment || '-'}</span>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // ä¿å­˜å½“å‰å…³ç³»æ•°æ®ç”¨äºç¼–è¾‘
        let currentRelationData = null;
        
        function renderRelationDetail(relation) {
            const content = document.getElementById('detailContent');
            
            // ä¿å­˜å½“å‰å…³ç³»æ•°æ®
            currentRelationData = relation;
            
            content.innerHTML = `
                <!-- ç¼–è¾‘å·¥å…·æ  -->
                <div class="edit-toolbar">
                    <button class="btn btn-edit" onclick="openEditRelationModal()">
                        âœï¸ ç¼–è¾‘æ ‡ç­¾
                    </button>
                    <button class="btn btn-undo" onclick="openUndoModal()">
                        â†©ï¸ æ’¤é”€æ“ä½œ
                    </button>
                </div>
                
                <div class="detail-section">
                    <h3>å…³ç³»ä¿¡æ¯</h3>
                    <div class="property-list">
                        <div class="property-item">
                            <span class="label">æºå®ä½“</span>
                            <span class="value" style="word-break:break-all;">${relation.source_title}<br><small style="color:#999;">${relation.source}</small></span>
                        </div>
                        <div class="property-item">
                            <span class="label">å…³ç³»ç±»å‹</span>
                            <span class="value"><strong>${relation.relation_name}</strong></span>
                        </div>
                        <div class="property-item">
                            <span class="label">ç›®æ ‡å®ä½“</span>
                            <span class="value" style="word-break:break-all;">${relation.target_title}<br><small style="color:#999;">${relation.target}</small></span>
                        </div>
                        <div class="property-item">
                            <span class="label">æ ‡ç­¾/å¤‡æ³¨</span>
                            <span class="value">${relation.label || '<span style="color:#999;">-</span>'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function clearDetail() {
            document.getElementById('detailContent').innerHTML = '<div class="empty-state">é€‰æ‹©å·¦ä¾§é¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</div>';
            document.getElementById('reviewActions').style.display = 'none';
            document.getElementById('reviewComment').value = '';
        }
        
        async function submitReview(status) {
            if (!currentItem) return;
            
            const comment = document.getElementById('reviewComment').value;
            
            try {
                await api.review.submit({
                    subject_id: currentSubject,
                    target_type: currentItem.type,
                    target_id: currentItem.id,
                    target_title: currentItem.title,
                    entity_type: currentItem.entityType,
                    status: status,
                    comment: comment || null
                });
                
                showToast('å®¡æ ¸æäº¤æˆåŠŸ', 'success');
                document.getElementById('reviewComment').value = '';
                
                // ä¿å­˜å½“å‰é¡¹çš„æ ‡è¯†ï¼Œç”¨äºåç»­å®šä½
                const currentId = currentItem.id;
                const currentIndex = currentItem.index;
                
                // åˆ·æ–°åˆ—è¡¨
                await loadList();
                
                // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€æ¡å¾…å®¡æ ¸è®°å½•
                await selectNextPendingItem(currentId, currentIndex);
                
            } catch (error) {
                showToast('æäº¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function selectNextPendingItem(previousId, previousIndex) {
            // ç­‰å¾…DOMæ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // è·å–å½“å‰åˆ—è¡¨ä¸­çš„æ‰€æœ‰é¡¹
            const items = document.querySelectorAll('.entity-item');
            let foundPrevious = false;
            let nextPendingItem = null;
            
            // æ‰¾åˆ°ä¸Šä¸€ä¸ªé¡¹ä¹‹åçš„ç¬¬ä¸€æ¡å¾…å®¡æ ¸è®°å½•
            for (let item of items) {
                const itemId = item.dataset.id || item.dataset.index;
                
                // å¦‚æœå·²ç»æ‰¾åˆ°äº†ä¹‹å‰çš„é¡¹ï¼Œç°åœ¨å¯»æ‰¾ä¸‹ä¸€æ¡å¾…å®¡æ ¸
                if (foundPrevious) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå¾…å®¡æ ¸çŠ¶æ€ï¼ˆæ²¡æœ‰badgeæˆ–badgeä¸ºpendingï¼‰
                    const badges = item.querySelectorAll('.badge');
                    const hasPendingBadge = Array.from(badges).some(b => b.classList.contains('badge-pending'));
                    const hasOtherBadge = Array.from(badges).some(b => 
                        b.classList.contains('badge-approved') || 
                        b.classList.contains('badge-needs_fix')
                    );
                    
                    // å¦‚æœæ²¡æœ‰ä»»ä½•å®¡æ ¸çŠ¶æ€badgeï¼Œæˆ–è€…æœ‰pending badgeï¼Œå°±é€‰è¿™ä¸€æ¡
                    if (!hasOtherBadge || hasPendingBadge) {
                        nextPendingItem = item;
                        break;
                    }
                }
                
                // æ ‡è®°å·²æ‰¾åˆ°ä¹‹å‰çš„é¡¹
                if (itemId === String(previousId) || itemId === String(previousIndex)) {
                    foundPrevious = true;
                }
            }
            
            // å¦‚æœæ‰¾åˆ°äº†ä¸‹ä¸€æ¡ï¼Œç‚¹å‡»å®ƒ
            if (nextPendingItem) {
                nextPendingItem.click();
                return;
            }
            
            // å¦‚æœå½“å‰é¡µæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•åŠ è½½ä¸‹ä¸€é¡µ
            const paginationButtons = document.querySelectorAll('#pagination button');
            const nextPageBtn = paginationButtons[paginationButtons.length - 1];
            
            if (nextPageBtn && !nextPageBtn.disabled) {
                // æœ‰ä¸‹ä¸€é¡µï¼ŒåŠ è½½å®ƒ
                currentPage++;
                await loadList();
                
                // ç­‰å¾…åˆ—è¡¨åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // é€‰æ‹©æ–°é¡µé¢çš„ç¬¬ä¸€æ¡å¾…å®¡æ ¸è®°å½•
                const allItems = document.querySelectorAll('.entity-item');
                for (let item of allItems) {
                    const badges = item.querySelectorAll('.badge');
                    const hasOtherBadge = Array.from(badges).some(b => 
                        b.classList.contains('badge-approved') || 
                        b.classList.contains('badge-needs_fix')
                    );
                    
                    if (!hasOtherBadge) {
                        item.click();
                        return;
                    }
                }
            }
            
            // æ‰€æœ‰å¾…å®¡æ ¸é¡¹éƒ½å·²å®Œæˆ
            showToast('ğŸ‰ å·²å®Œæˆæ‰€æœ‰å¾…å®¡æ ¸é¡¹ï¼', 'success');
            clearDetail();
        }
        
        // æŠ˜å /å±•å¼€åŠŸèƒ½
        function toggleCollapsible(element) {
            element.classList.toggle('collapsed');
        }
        
        function getStatusText(status) {
            const map = {
                'pending': 'å¾…å®¡æ ¸',
                'approved': 'å·²é€šè¿‡',
                'needs_fix': 'éœ€ä¿®æ”¹',
                'rejected': 'å·²æ‹’ç»'
            };
            return map[status] || status;
        }
        
        // ========== ç¼–è¾‘åŠŸèƒ½ ==========
        
        // æ¨¡æ€æ¡†æ§åˆ¶
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // æ‰“å¼€ç¼–è¾‘å®ä½“æ¨¡æ€æ¡†
        function openEditEntityModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            const entity = currentEntityData.entity;
            document.getElementById('editEntityId').value = entity.identifier;
            document.getElementById('editEntityTitle').value = entity.title || '';
            document.getElementById('editEntityDescription').value = entity.description || '';
            document.getElementById('editEntityType').value = entity.type || '';
            
            // åŠ¨æ€ç”Ÿæˆé¢å¤–å­—æ®µçš„ç¼–è¾‘åŒºåŸŸ
            const basicFields = ['identifier', 'type', 'title', 'description', 'subject', '_entity_type'];
            const extraFields = Object.keys(entity).filter(k => !basicFields.includes(k));
            
            const extraFieldsContainer = document.getElementById('editExtraFields');
            if (extraFields.length > 0) {
                extraFieldsContainer.innerHTML = `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <h4 style="margin-bottom: 10px; color: #666;">å…¶ä»–å±æ€§</h4>
                        ${extraFields.map(field => {
                            const value = entity[field];
                            const isObject = typeof value === 'object' && value !== null;
                            const displayValue = isObject ? JSON.stringify(value, null, 2) : (value || '');
                            return `
                                <div class="form-group">
                                    <label>${field}</label>
                                    <textarea 
                                        id="editExtra_${field}" 
                                        data-field="${field}" 
                                        data-is-json="${isObject}"
                                        class="extra-field-input"
                                        style="height: ${isObject ? '120px' : '60px'}; font-family: ${isObject ? 'monospace' : 'inherit'}; font-size: ${isObject ? '12px' : '14px'};"
                                    >${displayValue}</textarea>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                extraFieldsContainer.innerHTML = '';
            }
            
            openModal('editEntityModal');
        }
        
        // ä¿å­˜å®ä½“ç¼–è¾‘
        async function saveEntityEdit() {
            const identifier = document.getElementById('editEntityId').value;
            const updates = {
                title: document.getElementById('editEntityTitle').value,
                description: document.getElementById('editEntityDescription').value,
                type: document.getElementById('editEntityType').value
            };
            
            // æ”¶é›†é¢å¤–å­—æ®µçš„å€¼
            document.querySelectorAll('.extra-field-input').forEach(input => {
                const field = input.dataset.field;
                const isJson = input.dataset.isJson === 'true';
                let value = input.value.trim();
                
                if (isJson && value) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        showToast(`å­—æ®µ ${field} çš„ JSON æ ¼å¼æ— æ•ˆ`, 'error');
                        return;
                    }
                }
                
                updates[field] = value || null;
            });
            
            try {
                await api.edit.updateEntity(currentSubject, identifier, updates);
                showToast('å®ä½“æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editEntityModal');
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‰“å¼€æ·»åŠ å…³ç³»æ¨¡æ€æ¡†
        function openAddRelationModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            // é¢„å¡«æºå®ä½“
            document.getElementById('relationSource').value = currentEntityData.entity.identifier;
            document.getElementById('relationTarget').value = '';
            document.getElementById('relationLabel').value = '';
            
            openModal('addRelationModal');
        }
        
        // ä¿å­˜æ–°å…³ç³»
        async function saveNewRelation() {
            const relation = {
                source: document.getElementById('relationSource').value,
                target: document.getElementById('relationTarget').value,
                relation_name: document.getElementById('relationName').value,
                label: document.getElementById('relationLabel').value || null
            };
            
            if (!relation.source || !relation.target) {
                showToast('è¯·å¡«å†™æºå®ä½“å’Œç›®æ ‡å®ä½“', 'error');
                return;
            }
            
            try {
                await api.edit.createRelation(currentSubject, relation);
                showToast('å…³ç³»æ·»åŠ æˆåŠŸ', 'success');
                closeModal('addRelationModal');
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                const identifier = currentEntityData.entity.identifier;
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç¼–è¾‘å…³ç³»æ ‡ç­¾
        function openEditRelationModal() {
            if (!currentRelationData) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…³ç³»', 'error');
                return;
            }
            
            const relation = currentRelationData;
            document.getElementById('editRelationInfo').value = 
                `${relation.source_title} â†’ ${relation.relation_name} â†’ ${relation.target_title}`;
            document.getElementById('editRelationLabel').value = relation.label || '';
            
            openModal('editRelationModal');
        }
        
        async function saveRelationEdit() {
            if (!currentRelationData) return;
            
            const relation = currentRelationData;
            const newLabel = document.getElementById('editRelationLabel').value.trim();
            
            try {
                await api.edit.updateRelation(currentSubject, {
                    source: relation.source,
                    target: relation.target,
                    relation_name: relation.relation_name,
                    label: newLabel || null
                });
                
                showToast('å…³ç³»æ ‡ç­¾æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editRelationModal');
                
                // æ›´æ–°å½“å‰æ•°æ®å¹¶åˆ·æ–°æ˜¾ç¤º
                relation.label = newLabel || null;
                renderRelationDetail(relation);
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å…³ç³»ç›¸å…³
        let pendingDeleteRelation = null;
        
        function deleteRelation(index) {
            if (!currentEntityData || !currentEntityData.relations) {
                return;
            }
            
            const relation = currentEntityData.relations[index];
            pendingDeleteRelation = relation;
            
            document.getElementById('deleteConfirmText').textContent = 
                `ç¡®å®šè¦åˆ é™¤å…³ç³» "${relation.source_title} â†’ ${relation.relation_name} â†’ ${relation.target_title}" å—ï¼Ÿ`;
            
            openModal('confirmDeleteModal');
        }
        
        async function confirmDelete() {
            if (!pendingDeleteRelation) return;
            
            const relation = pendingDeleteRelation;
            
            try {
                const result = await api.edit.deleteRelation(currentSubject, {
                    source: relation.source,
                    target: relation.target,
                    relation_name: relation.relation_name
                });
                
                showToast('å…³ç³»åˆ é™¤æˆåŠŸï¼Œå¯ç‚¹å‡»"æ’¤é”€æ“ä½œ"æ¢å¤', 'success');
                closeModal('confirmDeleteModal');
                pendingDeleteRelation = null;
                
                // åˆ·æ–°å½“å‰å®ä½“è¯¦æƒ…
                const identifier = currentEntityData.entity.identifier;
                await selectEntity(encodeURIComponent(identifier));
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ========== æ’¤é”€åŠŸèƒ½ ==========
        
        async function openUndoModal() {
            if (!currentSubject) {
                showToast('è¯·å…ˆé€‰æ‹©å­¦ç§‘', 'error');
                return;
            }
            
            const listContainer = document.getElementById('undoHistoryList');
            listContainer.innerHTML = '<div class="empty-state">åŠ è½½ä¸­...</div>';
            
            openModal('undoModal');
            
            try {
                const result = await api.edit.getUndoHistory(currentSubject, 20);
                
                if (!result.undo_history || result.undo_history.length === 0) {
                    listContainer.innerHTML = '<div class="empty-state">æš‚æ— å¯æ’¤é”€çš„æ“ä½œ</div>';
                    return;
                }
                
                listContainer.innerHTML = result.undo_history.map(item => `
                    <div class="undo-item" style="padding: 12px; border: 1px solid #e8e8e8; border-radius: 6px; margin-bottom: 10px; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500; color: #333;">${item.original_file}</div>
                                <div style="font-size: 12px; color: #888; margin-top: 4px;">
                                    ç±»å‹: ${item.backup_type === 'relation' ? 'å…³ç³»' : item.backup_type === 'entity' ? 'å®ä½“' : 'æœªçŸ¥'} | 
                                    å¤‡ä»½æ—¶é—´: ${item.created_at_human}
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="executeUndo('${item.backup_file}')" style="padding: 6px 16px;">
                                æ¢å¤æ­¤ç‰ˆæœ¬
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listContainer.innerHTML = `<div class="empty-state" style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function executeUndo(backupFile) {
            if (!confirm('ç¡®å®šè¦æ¢å¤åˆ°æ­¤ç‰ˆæœ¬å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼ˆä½†ä¼šå…ˆå¤‡ä»½å½“å‰æ•°æ®ï¼‰ã€‚')) {
                return;
            }
            
            try {
                const result = await api.edit.undo(currentSubject, backupFile);
                
                showToast(result.message || 'æ’¤é”€æˆåŠŸ', 'success');
                closeModal('undoModal');
                
                // åˆ·æ–°å½“å‰è§†å›¾
                if (currentTab === 'entity' && currentEntityData) {
                    await selectEntity(encodeURIComponent(currentEntityData.entity.identifier));
                } else {
                    await loadList();
                }
            } catch (error) {
                showToast('æ’¤é”€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‰“å¼€å›¾è°±å¯è§†åŒ–æ¨¡æ€æ¡†
        async function openGraphModal() {
            if (!currentEntityData || !currentEntityData.entity) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä½“', 'error');
                return;
            }
            
            const entity = currentEntityData.entity;
            const container = document.getElementById('graphContainer');
            container.innerHTML = '<div class="empty-state">åŠ è½½å›¾è°±æ•°æ®ä¸­...</div>';
            
            // è®¾ç½®å…¨å±é“¾æ¥
            document.getElementById('graphFullLink').href = 
                `/static/index.html?subject=${currentSubject}&focus=${encodeURIComponent(entity.identifier)}`;
            
            openModal('graphModal');
            
            try {
                const graphData = await api.graph.getEntityGraph(currentSubject, entity.identifier, 1, 30);
                renderMiniGraph(container, graphData);
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“ç®€æ˜“å›¾è°±ï¼ˆä½¿ç”¨SVGï¼‰
        function renderMiniGraph(container, data) {
            if (!data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— å›¾è°±æ•°æ®</div>';
                return;
            }
            
            const width = container.clientWidth || 800;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // ç®€å•çš„åŠ›å¯¼å‘å¸ƒå±€æ¨¡æ‹Ÿ
            const nodes = data.nodes.map((node, i) => {
                const angle = (2 * Math.PI * i) / data.nodes.length;
                const radius = i === 0 ? 0 : 120 + Math.random() * 60;
                return {
                    ...node,
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });
            
            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);
            
            // ç”ŸæˆSVG
            let svg = `<svg width="${width}" height="${height}" style="font-family: sans-serif;">`;
            
            // ç»˜åˆ¶è¾¹
            if (data.edges) {
                data.edges.forEach(edge => {
                    const source = nodeMap[edge.source];
                    const target = nodeMap[edge.target];
                    if (source && target) {
                        svg += `<line x1="${source.x}" y1="${source.y}" x2="${target.x}" y2="${target.y}" 
                                stroke="#ccc" stroke-width="1"/>`;
                        // è¾¹æ ‡ç­¾
                        const midX = (source.x + target.x) / 2;
                        const midY = (source.y + target.y) / 2;
                        svg += `<text x="${midX}" y="${midY}" fill="#999" font-size="10" text-anchor="middle">${edge.label || ''}</text>`;
                    }
                });
            }
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            nodes.forEach((node, i) => {
                const isCenter = i === 0;
                const r = isCenter ? 25 : 18;
                const fill = isCenter ? '#1890ff' : '#52c41a';
                
                svg += `<circle cx="${node.x}" cy="${node.y}" r="${r}" fill="${fill}" stroke="white" stroke-width="2"/>`;
                svg += `<text x="${node.x}" y="${node.y + r + 15}" fill="#333" font-size="11" text-anchor="middle">${node.label || node.id}</text>`;
            });
            
            svg += '</svg>';
            container.innerHTML = svg;
        }
    </script>
</body>
</html>
