# 知识图谱数据审校系统 - 操作手册

## 目录

1. [快速开始](#快速开始)
2. [部署方式](#部署方式)
3. [用户管理](#用户管理)
4. [日常操作](#日常操作)
5. [故障排查](#故障排查)

---

## 快速开始

### 系统要求

- Python 3.9+
- 8GB+ 内存（推荐）
- 生产环境建议使用 MySQL 8.0+

### 本地开发启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 启动服务（开发模式）
python server.py --reload

# 3. 访问系统
# 登录页面: http://localhost:8000
# API文档:  http://localhost:8000/docs
```

### 默认账号

| 用户名 | 密码    | 角色 | 说明 |
|--------|---------|------|------|
| root   | root123 | root | 超级管理员（首次登录请修改密码） |

---

## 部署方式

### 方式一：直接部署（推荐用于小规模）

```bash
# 1. 创建配置文件
cp docker/env.example .env
# 编辑 .env 文件，修改密码等配置

# 2. 首次启动（初始化数据库）
./scripts/start_production.sh --init-db

# 3. 后续启动
./scripts/start_production.sh start

# 4. 停止服务
./scripts/start_production.sh stop

# 5. 查看状态
./scripts/start_production.sh status

# 6. 查看日志
./scripts/start_production.sh logs
```

### 方式二：Docker Compose 部署（推荐用于生产环境）

```bash
# 1. 进入 docker 目录
cd docker

# 2. 创建配置文件
cp env.example .env
# 编辑 .env 文件

# 3. 启动服务
docker-compose up -d

# 4. 查看日志
docker-compose logs -f app

# 5. 停止服务
docker-compose down
```

### 配置说明

`.env` 文件关键配置：

```bash
# 生产模式（启用保护机制）
PRODUCTION=true

# 数据库类型
DB_TYPE=mysql  # 生产环境使用 mysql

# MySQL配置（请修改为强密码！）
MYSQL_PASSWORD=your_strong_password

# JWT密钥（至少32字符的随机字符串）
# 可用命令生成: openssl rand -hex 32
JWT_SECRET_KEY=your_very_long_secret_key
```

---

## 用户管理

### 角色说明

| 角色 | 权限 |
|------|------|
| root | 超级管理员，所有权限 |
| admin | 管理员，可管理用户和学科分配 |
| teacher | 教师，可审核分配的学科数据 |

### 创建用户

1. 使用 root 或 admin 账号登录
2. 进入"用户管理"页面
3. 点击"添加用户"
4. 填写用户信息并选择角色
5. 为教师分配学科

### 分配学科

1. 在用户管理页面找到目标用户
2. 点击"编辑"按钮
3. 在"学科分配"区域选择学科
4. 保存更改

---

## 日常操作

### 审核数据

1. 登录系统进入工作台
2. 选择要审核的学科
3. 在"数据审核"页面浏览实体/关系
4. 选择项目查看详情
5. 点击"通过"或"需修改"提交审核
6. 可选填写审核意见

### 编辑数据

1. 在数据详情页面点击"编辑属性"
2. 修改实体的标题、描述等属性
3. 点击"保存"
4. 系统会自动创建备份

### 管理关系

- **添加关系**：点击"添加关系"按钮，填写源实体、关系类型、目标实体
- **删除关系**：在关系列表中点击"删除"按钮（需二次确认）

### 查看图谱

1. 选择一个实体
2. 点击"查看图谱"按钮
3. 在弹窗中查看该实体的关联关系图
4. 点击"全屏查看"可在新页面查看完整图谱

---

## 故障排查

### 常见问题

#### 1. 无法登录

**可能原因：**
- 用户名或密码错误
- 账号被禁用
- Token过期

**解决方案：**
- 检查用户名和密码
- 联系管理员确认账号状态
- 清除浏览器缓存后重新登录

#### 2. 编辑失败 "无法获取文件锁"

**原因：** 其他用户正在编辑同一文件

**解决方案：**
- 等待几秒后重试
- 如持续失败，联系管理员检查是否有卡住的进程

#### 3. 数据库连接失败

**排查步骤：**
```bash
# 检查服务状态
./scripts/start_production.sh status

# 查看日志
./scripts/start_production.sh logs

# 检查数据库文件（SQLite模式）
ls -la data/review.db
```

#### 4. 服务无法启动

**排查步骤：**
```bash
# 检查端口占用
lsof -i :8011

# 检查Python依赖
pip install -r requirements.txt

# 直接运行查看错误
python server.py
```

### 数据备份与恢复

#### 自动备份

系统在以下情况会自动创建备份：
- 编辑实体属性
- 添加/删除关系
- 重新初始化数据库

备份位置：
- 数据库备份：`data/backups/`
- JSON文件备份：`图谱数据/{学科}/backups/`

#### 手动备份

```bash
# 备份数据库
cp data/review.db data/review_$(date +%Y%m%d).db.bak

# 备份所有数据
tar -czvf backup_$(date +%Y%m%d).tar.gz data/ 图谱数据/
```

#### 恢复数据

```bash
# 恢复数据库
cp data/backups/review_20260122.db.bak data/review.db

# 恢复JSON文件
cp 图谱数据/高中数学-v1/backups/Chapter_20260122.bak \
   图谱数据/高中数学-v1/entities/Chapter.json
```

### 联系支持

如遇到无法解决的问题，请提供以下信息：
1. 错误截图
2. 操作步骤
3. 服务器日志（`logs/server.log`）
4. 浏览器控制台错误

---

## 附录

### 目录结构

```
get_neooo_html/
├── server.py           # 主服务入口
├── src/                # 源代码
│   └── api/            # API接口
├── static/             # 静态文件
│   └── app/            # 审校系统前端
├── data/               # 数据库文件
├── 图谱数据/           # 知识图谱JSON数据
├── logs/               # 日志文件
├── scripts/            # 脚本工具
└── docker/             # Docker配置
```

### 常用命令

```bash
# 启动开发服务器
python server.py --reload

# 启动生产服务器
python server.py --host 0.0.0.0 --port 8011 --production

# 重新初始化数据库
python server.py --init-db

# 运行测试（仅限开发环境）
python tests/test_data.py
```
