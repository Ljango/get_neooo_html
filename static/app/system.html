<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - çŸ¥è¯†å›¾è°±æ•°æ®å®¡æ ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <style>
        .output-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: var(--radius);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .output-panel.loading::after {
            content: 'æ‰§è¡Œä¸­...';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .operation-section {
            margin-bottom: 30px;
        }
        
        .operation-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .subject-select-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .subject-select-row select {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>çŸ¥è¯†å›¾è°±å®¡æ ¡ç³»ç»Ÿ</h2>
            </div>
            
            <nav class="sidebar-menu">
                <a href="/static/app/dashboard.html" class="menu-item">
                    <i>ğŸ“Š</i> <span>å·¥ä½œå°</span>
                </a>
                <a href="/static/app/review.html" class="menu-item">
                    <i>âœï¸</i> <span>æ•°æ®å®¡æ ¸</span>
                </a>
                <a href="/static/index.html" class="menu-item" target="_blank">
                    <i>ğŸ”—</i> <span>å›¾è°±å¯è§†åŒ–</span>
                </a>
                
                <div class="menu-divider" data-role="admin"></div>
                <div class="menu-label" data-role="admin">ç®¡ç†åŠŸèƒ½</div>
                
                <a href="/static/app/admin.html" class="menu-item" data-role="admin">
                    <i>ğŸ‘¥</i> <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="/static/app/system.html" class="menu-item active" data-role="root,engineer">
                    <i>âš™ï¸</i> <span>ç³»ç»Ÿç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">
                        <span>ç”¨æˆ·</span>
                        <div class="user-role">è§’è‰²</div>
                    </div>
                </div>
                <a href="#" id="logoutBtn" style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 10px;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title">ç³»ç»Ÿç®¡ç†</h1>
                <div class="header-actions">
                    <span id="roleIndicator" style="color: var(--text-muted); font-size: 13px;"></span>
                </div>
            </header>
            
            <main class="content">
                <!-- åŒæ­¥çŠ¶æ€æç¤º -->
                <div id="syncAlert" class="card" style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border: 1px solid #ffc107; margin-bottom: 20px;">
                    <div class="card-body" style="padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 24px;">âš ï¸</span>
                            <div style="flex: 1;">
                                <strong style="color: #856404;">æœ‰æ•°æ®ä¿®æ”¹å¾…åŒæ­¥</strong>
                                <p id="syncAlertText" style="margin: 5px 0 0; color: #856404; font-size: 13px;">
                                    éƒ¨åˆ†å­¦ç§‘çš„JSONæ•°æ®å·²è¢«ä¿®æ”¹ï¼Œä½†HTMLé¡µé¢å°šæœªæ›´æ–°ã€‚è¯·ç‚¹å‡»"åŒæ­¥æ•°æ®"æŒ‰é’®æ¥æ›´æ–°ã€‚
                                </p>
                            </div>
                            <button class="btn btn-warning" onclick="runOperation('sync')" style="white-space: nowrap;">
                                ğŸ”„ ç«‹å³åŒæ­¥
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å­¦ç§‘é€‰æ‹© -->
                <div class="subject-select-row">
                    <label>é€‰æ‹©å­¦ç§‘ï¼š</label>
                    <select id="subjectSelect">
                        <option value="">å…¨éƒ¨å­¦ç§‘</option>
                    </select>
                    <span style="color: var(--text-muted); font-size: 13px;">ï¼ˆç•™ç©ºè¡¨ç¤ºæ“ä½œæ‰€æœ‰å­¦ç§‘ï¼‰</span>
                </div>
                
                <!-- æ•°æ®æ£€æŸ¥ä¸ä¿®å¤ -->
                <div class="operation-section">
                    <h3>ğŸ“‹ æ•°æ®æ£€æŸ¥ä¸ä¿®å¤</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('normalize-check')">
                            <i>ğŸ”</i>
                            <div class="title">æ£€æŸ¥æ•°æ®è§„èŒƒ</div>
                            <div class="desc">æ£€æŸ¥æ•°æ®æ ¼å¼é—®é¢˜</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('normalize-fix')">
                            <i>ğŸ”§</i>
                            <div class="title">ä¿®å¤æ•°æ®è§„èŒƒ</div>
                            <div class="desc">è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('analyze')">
                            <i>ğŸ“Š</i>
                            <div class="title">è´¨é‡åˆ†æ</div>
                            <div class="desc">ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š</div>
                        </div>
                    </div>
                </div>
                
                <!-- å›¾è°±ç”Ÿæˆ -->
                <div class="operation-section">
                    <h3>ğŸŒ å›¾è°±ç”Ÿæˆ</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('generate-html')">
                            <i>ğŸ“„</i>
                            <div class="title">ç”ŸæˆHTML</div>
                            <div class="desc">é‡æ–°ç”Ÿæˆå›¾è°±é¡µé¢</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('sync')">
                            <i>ğŸ”„</i>
                            <div class="title">åŒæ­¥æ•°æ®</div>
                            <div class="desc">ç”ŸæˆHTML+æ›´æ–°ç´¢å¼•</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®åº“æ“ä½œ -->
                <div class="operation-section">
                    <h3>ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ</h3>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="runOperation('import-neo4j')">
                            <i>ğŸ“¥</i>
                            <div class="title">å¯¼å…¥Neo4j</div>
                            <div class="desc">åŒæ­¥åˆ°å›¾æ•°æ®åº“</div>
                        </div>
                        <div class="operation-btn" onclick="runOperation('export')">
                            <i>ğŸ“¤</i>
                            <div class="title">å¯¼å‡ºExcel</div>
                            <div class="desc">å¯¼å‡ºæ•°æ®åˆ°Excel</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®åŒ…ä¸Šä¼ ï¼ˆengineerä¹Ÿå¯ç”¨ï¼‰ -->
                <div class="operation-section" id="uploadSection">
                    <h3>ğŸ“¤ æ•°æ®åŒ…ä¸Šä¼ </h3>
                    <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 13px;">
                        ä¸Šä¼ ZIPæ ¼å¼çš„çŸ¥è¯†å›¾è°±æ•°æ®åŒ…ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯æ•°æ®æ ¼å¼ï¼ŒéªŒè¯é€šè¿‡åå¯¼å…¥åˆ°æŒ‡å®šå­¦ç§‘ã€‚
                    </p>
                    
                    <div class="card">
                        <div class="card-body" style="padding: 20px;">
                            <!-- ä¸Šä¼ è¡¨å• -->
                            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                                <div style="flex: 0 0 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç›®æ ‡å­¦ç§‘</label>
                                    <select id="uploadSubjectSelect" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius);">
                                        <option value="">-- è¯·é€‰æ‹©å­¦ç§‘ --</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">é€‰æ‹©ZIPæ–‡ä»¶</label>
                                    <input type="file" id="uploadFileInput" accept=".zip" 
                                        style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius); background: #fff;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="validateUpload()" id="validateBtn">
                                        ğŸ” éªŒè¯æ ¼å¼
                                    </button>
                                    <button class="btn btn-primary" onclick="uploadData()" id="uploadBtn" disabled>
                                        ğŸ“¤ ä¸Šä¼ å¯¼å…¥
                                    </button>
                                </div>
                            </div>
                            
                            <!-- å¤‡ä»½é€‰é¡¹ -->
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="uploadBackupCheck" checked>
                                    <span style="font-size: 13px;">å¯¼å…¥å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼ˆæ¨èï¼‰</span>
                                </label>
                            </div>
                            
                            <!-- éªŒè¯ç»“æœ -->
                            <div id="validationResult" style="display: none; margin-top: 15px; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border-color);">
                            </div>
                            
                            <!-- æ ¼å¼è¯´æ˜ -->
                            <div style="margin-top: 15px;">
                                <button class="btn btn-link" onclick="toggleFormatSpec()" style="padding: 0; color: var(--primary-color);">
                                    ğŸ“‹ æŸ¥çœ‹æ•°æ®åŒ…æ ¼å¼è§„èŒƒ
                                </button>
                                <div id="formatSpec" style="display: none; margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: var(--radius); font-size: 13px;">
                                    <pre style="margin: 0; white-space: pre-wrap;">ZIPåŒ…ç»“æ„ï¼š
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ Chapter.json
â”‚   â”œâ”€â”€ Section.json
â”‚   â””â”€â”€ ...
â””â”€â”€ relations/
    â”œâ”€â”€ Chapter_Section_relations.json
    â””â”€â”€ ...

å®ä½“JSONå¿…éœ€å­—æ®µï¼šidentifier, title, type
å…³ç³»JSONå¿…éœ€å­—æ®µï¼šsource, target, relationName</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®å¿«ç…§ç®¡ç† -->
                <div class="operation-section">
                    <h3>ğŸ“¦ æ•°æ®å¿«ç…§ç®¡ç†</h3>
                    <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 13px;">
                        å¿«ç…§åŠŸèƒ½ç”¨äºå¤‡ä»½å’Œæ¢å¤å­¦ç§‘JSONæ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚é€‰æ‹©å­¦ç§‘åå¯åˆ›å»ºå¿«ç…§æˆ–ä»å¿«ç…§æ¢å¤ã€‚
                    </p>
                    <div class="operation-grid">
                        <div class="operation-btn" onclick="createSnapshot()">
                            <i>ğŸ“¸</i>
                            <div class="title">åˆ›å»ºå¿«ç…§</div>
                            <div class="desc">å¤‡ä»½å½“å‰å­¦ç§‘æ•°æ®</div>
                        </div>
                        <div class="operation-btn" onclick="loadSnapshots()">
                            <i>ğŸ“‹</i>
                            <div class="title">æŸ¥çœ‹å¿«ç…§åˆ—è¡¨</div>
                            <div class="desc">ç®¡ç†å·²æœ‰å¿«ç…§</div>
                        </div>
                    </div>
                    
                    <!-- å¿«ç…§åˆ—è¡¨ -->
                    <div class="card" id="snapshotListCard" style="display: none; margin-top: 20px;">
                        <div class="card-header">
                            <span id="snapshotListTitle">å¿«ç…§åˆ—è¡¨</span>
                            <button class="btn" onclick="hideSnapshots()" style="padding: 4px 10px; font-size: 12px;">å…³é—­</button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ç‰ˆæœ¬</th>
                                            <th>æ–‡ä»¶å</th>
                                            <th>å¤§å°</th>
                                            <th>åˆ›å»ºæ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="snapshotTableBody">
                                        <tr><td colspan="5">è¯·å…ˆé€‰æ‹©å­¦ç§‘å¹¶ç‚¹å‡»"æŸ¥çœ‹å¿«ç…§åˆ—è¡¨"</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å‡ºé¢æ¿ -->
                <div class="card">
                    <div class="card-header">
                        æ‰§è¡Œè¾“å‡º
                        <button class="btn" onclick="clearOutput()" style="padding: 4px 10px; font-size: 12px;">æ¸…ç©º</button>
                    </div>
                    <div class="card-body">
                        <div class="output-panel" id="outputPanel">ç­‰å¾…æ‰§è¡Œå‘½ä»¤...</div>
                    </div>
                </div>
                
                <!-- æ“ä½œæ—¥å¿— -->
                <div class="card">
                    <div class="card-header">
                        æœ€è¿‘æ“ä½œæ—¥å¿—
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>ç”¨æˆ·</th>
                                        <th>æ“ä½œ</th>
                                        <th>è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <tr><td colspan="4" class="loading">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="toast-container"></div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // æ£€æŸ¥æƒé™ï¼ˆrootå’Œengineerå¯ä»¥è®¿é—®ï¼‰
        const user = getUserInfo();
        const userRoles = user?.roles || [user?.role] || [];
        const isRoot = userRoles.includes('root');
        const isEngineer = userRoles.includes('engineer') || userRoles.includes('admin');
        
        if (!isRoot && !isEngineer) {
            showToast('æ— æƒè®¿é—®æ­¤é¡µé¢', 'error');
            setTimeout(() => window.location.href = '/static/app/dashboard.html', 1000);
        }
        
        initPage();
        
        // æ˜¾ç¤ºè§’è‰²æŒ‡ç¤ºå™¨
        document.getElementById('roleIndicator').textContent = isRoot ? '(ç®¡ç†å‘˜æƒé™)' : '(å›¾è°±å·¥ç¨‹å¸ˆæƒé™)';
        
        // æ ¹æ®è§’è‰²æ§åˆ¶æ˜¾ç¤º
        if (!isRoot) {
            // érootç”¨æˆ·éšè—éƒ¨åˆ†åŠŸèƒ½
            document.querySelectorAll('.operation-section').forEach((section, index) => {
                const h3 = section.querySelector('h3');
                if (h3 && h3.textContent.includes('æ•°æ®åº“æ“ä½œ')) {
                    section.style.display = 'none';
                }
            });
            // éšè—åŒæ­¥æç¤ºä¸­çš„ç«‹å³åŒæ­¥æŒ‰é’®
            const syncAlert = document.getElementById('syncAlert');
            if (syncAlert) {
                const syncBtn = syncAlert.querySelector('button');
                if (syncBtn) syncBtn.style.display = 'none';
            }
        }
        
        // åŠ è½½æ•°æ®
        loadSubjects();
        loadLogs();
        loadSyncStatus();
        
        async function loadSubjects() {
            try {
                const result = await api.data.getSubjects();
                const select = document.getElementById('subjectSelect');
                
                result.subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Load subjects error:', error);
            }
        }
        
        async function loadSyncStatus() {
            try {
                const result = await api.data.getSyncStatus();
                const alert = document.getElementById('syncAlert');
                const text = document.getElementById('syncAlertText');
                
                if (result.total_need_sync > 0) {
                    const subjects = result.subjects_need_sync.map(s => 
                        `${s.display_name}(${s.edit_count}æ¬¡ä¿®æ”¹)`
                    ).join('ã€');
                    
                    text.textContent = `ä»¥ä¸‹å­¦ç§‘çš„æ•°æ®å·²ä¿®æ”¹ä½†æœªåŒæ­¥åˆ°HTML: ${subjects}`;
                    alert.style.display = 'block';
                } else {
                    alert.style.display = 'none';
                }
            } catch (error) {
                console.error('Load sync status error:', error);
            }
        }
        
        async function loadLogs() {
            const tbody = document.getElementById('logTableBody');
            
            try {
                const result = await api.admin.getLogs({ page_size: 20 });
                
                if (result.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">æš‚æ— æ—¥å¿—</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.logs.map(log => `
                    <tr>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                        <td>${log.user_name || '-'}</td>
                        <td>${getActionText(log.action)}</td>
                        <td>${log.details ? JSON.stringify(log.details).substring(0, 50) : '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color:red;">åŠ è½½å¤±è´¥</td></tr>`;
            }
        }
        
        async function runOperation(type) {
            const subject = document.getElementById('subjectSelect').value || null;
            const panel = document.getElementById('outputPanel');
            
            panel.textContent = 'æ‰§è¡Œä¸­...\n';
            panel.classList.add('loading');
            
            try {
                let result;
                
                switch (type) {
                    case 'normalize-check':
                        result = await api.data.normalize(subject, false);
                        break;
                    case 'normalize-fix':
                        if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ•°æ®ä¿®å¤å—ï¼Ÿè¿™å°†ä¿®æ”¹æ•°æ®æ–‡ä»¶ã€‚')) return;
                        result = await api.data.normalize(subject, true);
                        break;
                    case 'analyze':
                        result = await api.data.analyze(subject);
                        break;
                    case 'generate-html':
                        result = await api.data.generateHtml(subject);
                        break;
                    case 'sync':
                        result = await api.data.sync(subject);
                        loadSyncStatus(); // åˆ·æ–°åŒæ­¥çŠ¶æ€
                        break;
                    case 'import-neo4j':
                        result = await api.data.importNeo4j(subject, 'local', false);
                        break;
                    case 'export':
                        result = await api.data.exportData(subject);
                        break;
                }
                
                panel.textContent = result.output || result.message || 'æ‰§è¡Œå®Œæˆ';
                
                if (result.success) {
                    showToast('æ‰§è¡ŒæˆåŠŸ', 'success');
                } else {
                    showToast('æ‰§è¡Œå¤±è´¥', 'error');
                }
                
                // åˆ·æ–°æ—¥å¿—
                loadLogs();
                
            } catch (error) {
                panel.textContent = 'é”™è¯¯: ' + error.message;
                showToast('æ‰§è¡Œå¤±è´¥: ' + error.message, 'error');
            } finally {
                panel.classList.remove('loading');
            }
        }
        
        function clearOutput() {
            document.getElementById('outputPanel').textContent = 'ç­‰å¾…æ‰§è¡Œå‘½ä»¤...';
        }
        
        function getActionText(action) {
            const map = {
                'login': 'ç™»å½•',
                'logout': 'é€€å‡º',
                'create_user': 'åˆ›å»ºç”¨æˆ·',
                'update_user': 'æ›´æ–°ç”¨æˆ·',
                'delete_user': 'åˆ é™¤ç”¨æˆ·',
                'reset_password': 'é‡ç½®å¯†ç ',
                'assign_subject': 'åˆ†é…å­¦ç§‘',
                'remove_assignment': 'ç§»é™¤åˆ†é…',
                'submit_review': 'æäº¤å®¡æ ¸',
                'data_normalize': 'æ•°æ®è§„èŒƒåŒ–',
                'data_analyze': 'æ•°æ®åˆ†æ',
                'generate_html': 'ç”ŸæˆHTML',
                'import_neo4j': 'å¯¼å…¥Neo4j',
                'sync_data': 'åŒæ­¥æ•°æ®',
                'export_data': 'å¯¼å‡ºæ•°æ®',
                'change_password': 'ä¿®æ”¹å¯†ç ',
                'create_snapshot': 'åˆ›å»ºå¿«ç…§',
                'restore_snapshot': 'æ¢å¤å¿«ç…§',
                'delete_snapshot': 'åˆ é™¤å¿«ç…§'
            };
            return map[action] || action;
        }
        
        // ========== å¿«ç…§ç®¡ç†åŠŸèƒ½ ==========
        
        async function createSnapshot() {
            const subject = document.getElementById('subjectSelect').value;
            if (!subject) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­¦ç§‘', 'error');
                return;
            }
            
            const description = prompt('è¯·è¾“å…¥å¿«ç…§æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š', '');
            if (description === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            const panel = document.getElementById('outputPanel');
            panel.textContent = 'æ­£åœ¨åˆ›å»ºå¿«ç…§...\n';
            panel.classList.add('loading');
            
            try {
                const result = await api.data.createSnapshot(subject, 'auto', description);
                
                if (result.success) {
                    panel.textContent = `å¿«ç…§åˆ›å»ºæˆåŠŸï¼\n\n` +
                        `æ–‡ä»¶å: ${result.snapshot.filename}\n` +
                        `ç‰ˆæœ¬: ${result.snapshot.version}\n` +
                        `å®ä½“æ•°: ${result.snapshot.entities_count}\n` +
                        `å…³ç³»æ•°: ${result.snapshot.relations_count}\n` +
                        `å¤§å°: ${(result.snapshot.size / 1024 / 1024).toFixed(2)} MB`;
                    showToast('å¿«ç…§åˆ›å»ºæˆåŠŸ', 'success');
                    loadSnapshots(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    panel.textContent = 'åˆ›å»ºå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯');
                    showToast('åˆ›å»ºå¤±è´¥', 'error');
                }
                
                loadLogs();
            } catch (error) {
                panel.textContent = 'é”™è¯¯: ' + error.message;
                showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                panel.classList.remove('loading');
            }
        }
        
        async function loadSnapshots() {
            const subject = document.getElementById('subjectSelect').value;
            if (!subject) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­¦ç§‘', 'error');
                return;
            }
            
            const card = document.getElementById('snapshotListCard');
            const tbody = document.getElementById('snapshotTableBody');
            const title = document.getElementById('snapshotListTitle');
            
            card.style.display = 'block';
            title.textContent = `å¿«ç…§åˆ—è¡¨ - ${document.getElementById('subjectSelect').selectedOptions[0].text}`;
            tbody.innerHTML = '<tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const result = await api.data.listSnapshots(subject);
                
                if (result.snapshots.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">æš‚æ— å¿«ç…§ï¼Œç‚¹å‡»"åˆ›å»ºå¿«ç…§"æ¥å¤‡ä»½æ•°æ®</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.snapshots.map(s => `
                    <tr>
                        <td><strong>${s.version}</strong></td>
                        <td style="font-size: 12px; word-break: break-all;">${s.filename}</td>
                        <td>${s.size_human}</td>
                        <td>${new Date(s.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="restoreSnapshot('${subject}', '${s.filename}')" style="padding: 3px 8px; font-size: 11px;">
                                æ¢å¤
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSnapshot('${subject}', '${s.filename}')" style="padding: 3px 8px; font-size: 11px; margin-left: 5px;">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        function hideSnapshots() {
            document.getElementById('snapshotListCard').style.display = 'none';
        }
        
        async function restoreSnapshot(subjectId, filename) {
            if (!confirm(`ç¡®å®šè¦ä»å¿«ç…§ "${filename}" æ¢å¤æ•°æ®å—ï¼Ÿ\n\nâš ï¸ å½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰`)) {
                return;
            }
            
            const panel = document.getElementById('outputPanel');
            panel.textContent = 'æ­£åœ¨æ¢å¤æ•°æ®...\n';
            panel.classList.add('loading');
            
            try {
                const result = await api.data.restoreSnapshot(subjectId, filename);
                
                if (result.success) {
                    panel.textContent = `æ•°æ®æ¢å¤æˆåŠŸï¼\n\n` +
                        `æ¢å¤è‡ª: ${result.restored_from}\n` +
                        `åŸæ•°æ®å¤‡ä»½: ${result.backup_file}\n\n` +
                        (result.metadata ? 
                            `åŸå§‹ç‰ˆæœ¬: ${result.metadata.version}\n` +
                            `åˆ›å»ºè€…: ${result.metadata.created_by}\n` +
                            `å®ä½“æ•°: ${result.metadata.entities_count}\n` +
                            `å…³ç³»æ•°: ${result.metadata.relations_count}` : '');
                    showToast('æ•°æ®æ¢å¤æˆåŠŸ', 'success');
                    loadSnapshots();
                } else {
                    panel.textContent = 'æ¢å¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯');
                    showToast('æ¢å¤å¤±è´¥', 'error');
                }
                
                loadLogs();
            } catch (error) {
                panel.textContent = 'é”™è¯¯: ' + error.message;
                showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            } finally {
                panel.classList.remove('loading');
            }
        }
        
        async function deleteSnapshot(subjectId, filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¿«ç…§ "${filename}" å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const result = await api.data.deleteSnapshot(subjectId, filename);
                
                if (result.success) {
                    showToast('å¿«ç…§å·²åˆ é™¤', 'success');
                    loadSnapshots();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
                loadLogs();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ========== æ•°æ®åŒ…ä¸Šä¼ åŠŸèƒ½ ==========
        
        // åˆå§‹åŒ–ä¸Šä¼ å­¦ç§‘é€‰æ‹©å™¨
        async function initUploadSubjects() {
            try {
                const result = await api.data.getSubjects();
                const select = document.getElementById('uploadSubjectSelect');
                
                result.subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.subject_id;
                    option.textContent = `${s.icon || ''} ${s.display_name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Load subjects for upload error:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initUploadSubjects();
        
        // å­˜å‚¨éªŒè¯ç»“æœ
        let lastValidationResult = null;
        
        // éªŒè¯ä¸Šä¼ æ–‡ä»¶
        async function validateUpload() {
            const fileInput = document.getElementById('uploadFileInput');
            const resultDiv = document.getElementById('validationResult');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªZIPæ–‡ä»¶', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.zip')) {
                showToast('åªæ”¯æŒZIPæ ¼å¼æ–‡ä»¶', 'error');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: var(--text-muted);">ğŸ”„ æ­£åœ¨éªŒè¯...</p>';
            uploadBtn.disabled = true;
            
            try {
                const result = await api.data.validateUpload(file);
                lastValidationResult = result;
                
                const validation = result.validation;
                let html = '';
                
                if (validation.valid) {
                    html = `
                        <div style="color: #28a745;">
                            <strong>âœ… éªŒè¯é€šè¿‡</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            <p>ğŸ“ æ–‡ä»¶å: ${result.filename}</p>
                            <p>ğŸ“¦ æ–‡ä»¶å¤§å°: ${(result.file_size / 1024 / 1024).toFixed(2)} MB</p>
                            <p>ğŸ“Š å®ä½“æ–‡ä»¶: ${validation.entity_files.length} ä¸ª (å…± ${validation.total_entities} æ¡)</p>
                            <p>ğŸ”— å…³ç³»æ–‡ä»¶: ${validation.relation_files.length} ä¸ª (å…± ${validation.total_relations} æ¡)</p>
                        </div>
                    `;
                    
                    if (validation.warnings.length > 0) {
                        html += `
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                <strong style="color: #856404;">âš ï¸ è­¦å‘Š:</strong>
                                <ul style="margin: 5px 0 0 20px; color: #856404;">
                                    ${validation.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.borderColor = '#28a745';
                    uploadBtn.disabled = false;
                } else {
                    html = `
                        <div style="color: #dc3545;">
                            <strong>âŒ éªŒè¯å¤±è´¥</strong>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 4px;">
                            <strong>é”™è¯¯:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                ${validation.errors.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    
                    if (validation.warnings.length > 0) {
                        html += `
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                <strong style="color: #856404;">âš ï¸ è­¦å‘Š:</strong>
                                <ul style="margin: 5px 0 0 20px; color: #856404;">
                                    ${validation.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.borderColor = '#dc3545';
                    uploadBtn.disabled = true;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #dc3545;">âŒ éªŒè¯å¤±è´¥: ${error.message}</p>`;
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.borderColor = '#dc3545';
                uploadBtn.disabled = true;
            }
        }
        
        // ä¸Šä¼ æ•°æ®
        async function uploadData() {
            const subjectSelect = document.getElementById('uploadSubjectSelect');
            const fileInput = document.getElementById('uploadFileInput');
            const backupCheck = document.getElementById('uploadBackupCheck');
            const panel = document.getElementById('outputPanel');
            
            const subjectId = subjectSelect.value;
            if (!subjectId) {
                showToast('è¯·å…ˆé€‰æ‹©ç›®æ ‡å­¦ç§‘', 'error');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªZIPæ–‡ä»¶', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const backup = backupCheck.checked;
            
            // ç¡®è®¤ä¸Šä¼ 
            const subjectName = subjectSelect.selectedOptions[0].text;
            if (!confirm(`ç¡®å®šè¦å°†æ•°æ®å¯¼å…¥åˆ° "${subjectName}" å—ï¼Ÿ\n\n${backup ? 'å°†è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ã€‚' : 'âš ï¸ æœªå¯ç”¨å¤‡ä»½ï¼Œè¯·ç¡®ä¿å·²æ‰‹åŠ¨å¤‡ä»½é‡è¦æ•°æ®ï¼'}`)) {
                return;
            }
            
            panel.textContent = 'æ­£åœ¨ä¸Šä¼ å¹¶å¯¼å…¥æ•°æ®...\n';
            panel.classList.add('loading');
            
            try {
                const result = await api.data.uploadDataPackage(subjectId, file, backup);
                
                if (result.success) {
                    let output = `âœ… ${result.message}\n\n`;
                    output += `ğŸ“ å¯¼å…¥çš„å®ä½“æ–‡ä»¶:\n${result.imported.entity_files.map(f => `  - ${f}`).join('\n') || '  (æ— )'}\n\n`;
                    output += `ğŸ”— å¯¼å…¥çš„å…³ç³»æ–‡ä»¶:\n${result.imported.relation_files.map(f => `  - ${f}`).join('\n') || '  (æ— )'}\n\n`;
                    output += `ğŸ“Š ç»Ÿè®¡: ${result.imported.total_entities} ä¸ªå®ä½“, ${result.imported.total_relations} ä¸ªå…³ç³»\n`;
                    
                    if (result.backup) {
                        output += `\nğŸ’¾ å¤‡ä»½æ–‡ä»¶: ${result.backup}\n`;
                    }
                    
                    if (result.warnings && result.warnings.length > 0) {
                        output += `\nâš ï¸ è­¦å‘Š:\n${result.warnings.map(w => `  - ${w}`).join('\n')}`;
                    }
                    
                    if (result.needs_sync) {
                        output += `\n\nğŸ”„ æç¤º: æ•°æ®å·²å¯¼å…¥ï¼Œè¯·ç‚¹å‡»"åŒæ­¥æ•°æ®"æŒ‰é’®æ¥æ›´æ–°HTMLé¡µé¢ã€‚`;
                    }
                    
                    panel.textContent = output;
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                    
                    // é‡ç½®è¡¨å•
                    fileInput.value = '';
                    document.getElementById('validationResult').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    lastValidationResult = null;
                    
                    // åˆ·æ–°åŒæ­¥çŠ¶æ€
                    loadSyncStatus();
                } else {
                    let output = `âŒ å¯¼å…¥å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}\n`;
                    
                    if (result.errors && result.errors.length > 0) {
                        output += `\né”™è¯¯è¯¦æƒ…:\n${result.errors.map(e => `  - ${e}`).join('\n')}`;
                    }
                    
                    panel.textContent = output;
                    showToast('å¯¼å…¥å¤±è´¥', 'error');
                }
                
                loadLogs();
                
            } catch (error) {
                panel.textContent = 'é”™è¯¯: ' + error.message;
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                panel.classList.remove('loading');
            }
        }
        
        // åˆ‡æ¢æ ¼å¼è§„èŒƒæ˜¾ç¤º
        function toggleFormatSpec() {
            const spec = document.getElementById('formatSpec');
            spec.style.display = spec.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
